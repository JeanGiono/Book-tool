import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, deleteDoc, setDoc, serverTimestamp, orderBy } from 'firebase/firestore';
import { setLogLevel } from "firebase/app";

// Firebase 設定 - 增強 robustness
let parsedFirebaseConfig;
const defaultFirebaseConfig = {
    apiKey: "YOUR_API_KEY", // 請替換成您的 Firebase API Key
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// 檢查 __firebase_config 是否已定義且有效
if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== "") {
  try {
    parsedFirebaseConfig = JSON.parse(__firebase_config);
  } catch (e) {
    console.error("無法解析 __firebase_config，將使用預設 Firebase 設定。錯誤:", e);
    parsedFirebaseConfig = defaultFirebaseConfig;
  }
} else {
  // 如果 __firebase_config 未定義，或已定義但為空/無效，則使用預設設定
  if (typeof __firebase_config !== 'undefined') { // 檢查是否已定義但無效
     console.warn("__firebase_config 已定義但為空或無效，將使用預設 Firebase 設定。");
  }
  parsedFirebaseConfig = defaultFirebaseConfig;
}
const firebaseConfig = parsedFirebaseConfig;

// 檢查 __app_id 是否已定義
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-language-learner-app-multilang';

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

setLogLevel('debug'); // Firebase 日誌級別

// AI 生字簿的 Gemini API JSON Schema
const vocabGenerationSchema = {
  type: "OBJECT",
  properties: {
    "definitions": {
      "type": "ARRAY",
      "items": { "type": "STRING" },
      "description": "List of definitions for the word/phrase in its original language."
    },
    "translation_zh_TW": {
      "type": "STRING",
      "description": "Traditional Chinese translation of the word/phrase."
    },
    "example_sentence": {
      "type": "STRING",
      "description": "An example sentence using the word/phrase in its original language."
    },
    "error": {
      "type": "STRING",
      "description": "Error message if the word/phrase cannot be processed.",
      "optional": true
    }
  },
  required: ["definitions", "translation_zh_TW", "example_sentence"]
};

// AI 文章洞察的 Gemini API JSON Schema
const insightGenerationSchema = {
  type: "OBJECT",
  properties: {
    "key_vocabulary": {
      "type": "ARRAY",
      "description": "List of 5-7 key vocabulary words from the article, suitable for an intermediate learner of the article's language. Focus on less common but useful words.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "word": { "type": "STRING", "description": "The vocabulary word (in article's language)." },
          "definition_en": { "type": "STRING", "description": "Concise definition of the word in the article's language (prompt will specify this, field name kept for compatibility)." },
          "translation_zh_TW": { "type": "STRING", "description": "Traditional Chinese translation of the word." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article (in article's language) containing the word. If the word appears multiple times, choose a clear example." }
        },
        "required": ["word", "definition_en", "translation_zh_TW", "example_sentence_from_article"]
      }
    },
    "useful_phrases": {
      "type": "ARRAY",
      "description": "List of 3-5 useful phrases or idioms from the article (in article's language).",
      "items": {
        "type": "OBJECT",
        "properties": {
          "phrase": { "type": "STRING", "description": "The phrase or idiom (in article's language)." },
          "meaning_en": { "type": "STRING", "description": "Concise meaning of the phrase in the article's language (prompt will specify this, field name kept for compatibility)." },
          "translation_zh_TW": { "type": "STRING", "description": "Traditional Chinese translation of the phrase." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article (in article's language) containing the phrase." }
        },
        "required": ["phrase", "meaning_en", "translation_zh_TW", "example_sentence_from_article"]
      }
    },
    "grammar_highlights": {
      "type": "ARRAY",
      "description": "List of 2-3 noteworthy grammar structures or patterns from the article.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "grammar_point_name_zh_TW": { "type": "STRING", "description": "Name of the grammar point in Traditional Chinese (e.g., '[ArticleLanguage]的過去完成式', '[ArticleLanguage]的被動語態', '[ArticleLanguage]的動名詞作主語')." },
          "explanation_zh_TW": { "type": "STRING", "description": "Brief (1-2 sentences) explanation of the grammar rule in Traditional Chinese, focusing on its use in the example from the article." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article (in article's language) showcasing this grammar point." }
        },
        "required": ["grammar_point_name_zh_TW", "explanation_zh_TW", "example_sentence_from_article"]
      }
    }
  },
  required: ["key_vocabulary", "useful_phrases", "grammar_highlights"]
};

// AI 動詞變化查詢的 Gemini API JSON Schema
const verbConjugationSchema = {
  type: "OBJECT",
  properties: {
    "language_code_provided": { "type": "STRING", "description": "The ISO 639-1 language code provided in the prompt (e.g., 'en', 'fr'). Helps AI confirm context." },
    "verb_infinitive_src_lang": { "type": "STRING", "description": "The infinitive form of the verb in its original language." },
    "language_name_for_display_zh_TW": { "type": "STRING", "description": "The name of the language in Traditional Chinese for display purposes (e.g., '英文', '法文')." },
    "regularity_zh_TW": { "type": "STRING", "description": "Whether the verb is regular or irregular, in Traditional Chinese (e.g., '規則動詞', '不規則動詞')." },
    "verb_type_zh_TW": { "type": "STRING", "description": "Type of verb in Traditional Chinese (e.g., '主要動詞', '助動詞', '情態動詞'). Optional, can be '不適用' or omitted if not clear.", "optional": true },
    "conjugations": {
      "type": "ARRAY",
      "description": "Array of conjugation groups, typically by mood.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "group_name_src_lang": { "type": "STRING", "description": "Name of the conjugation group (e.g., Mood like 'Indicatif', 'Subjonctif') in the original language. Optional.", "optional": true },
          "group_name_zh_TW": { "type": "STRING", "description": "Name of the conjugation group in Traditional Chinese (e.g., '直陳式', '假設式')." },
          "tenses_or_voices": {
            "type": "ARRAY",
            "description": "Array of tenses or voices within this group.",
            "items": {
              "type": "OBJECT",
              "properties": {
                "sub_group_name_src_lang": { "type": "STRING", "description": "Name of this specific tense or voice (e.g., Tense like 'Présent', 'Passé composé'; Voice like 'Active Voice') in the original language. Optional.", "optional": true },
                "sub_group_name_zh_TW": { "type": "STRING", "description": "Name of this specific tense or voice in Traditional Chinese (e.g., '現在時', '複合過去時'; '主動態')." },
                "forms": {
                  "type": "ARRAY",
                  "description": "List of conjugated forms for different persons/numbers.",
                  "items": {
                    "type": "OBJECT",
                    "properties": {
                      "person_descriptor_src_lang": { "type": "STRING", "description": "Person/Number descriptor, ideally pronoun in original language (e.g., 'Je', 'I', 'Yo'). If not applicable, use a general descriptor." },
                      "conjugated_form_src_lang": { "type": "STRING", "description": "The conjugated verb form in the original language." }
                    },
                    "required": ["person_descriptor_src_lang", "conjugated_form_src_lang"]
                  }
                },
                "example_sentence_src_lang": { "type": "STRING", "description": "An example sentence in the original language using a form from this tense/voice. Optional.", "optional": true },
                "example_sentence_translation_zh_TW": { "type": "STRING", "description": "Traditional Chinese translation of the example sentence. Optional.", "optional": true }
              },
              "required": ["sub_group_name_zh_TW", "forms"]
            }
          }
        },
        "required": ["group_name_zh_TW", "tenses_or_voices"]
      }
    },
    "notes_zh_TW": { "type": "STRING", "description": "Any additional notes about the verb's conjugation in Traditional Chinese (e.g., common irregularities, usage notes). Optional.", "optional": true },
    "error": { "type": "STRING", "description": "Error message if the verb cannot be processed or is not found. Optional.", "optional": true }
  },
  required: ["language_code_provided", "verb_infinitive_src_lang", "language_name_for_display_zh_TW", "regularity_zh_TW", "conjugations"]
};

// AI 翻譯功能的 Gemini API JSON Schema
const translationSchema = {
  type: "OBJECT",
  properties: {
    "original_text": { 
      "type": "STRING",
      "description": "The original text that was provided for translation." 
    },
    "translated_text_zh_TW": { 
      "type": "STRING", 
      "description": "The translated text in Traditional Chinese." 
    },
    "source_language_code_detected": { 
      "type": "STRING", 
      "description": "The detected or provided ISO 639-1 language code of the original text." 
    },
    "error": { 
      "type": "STRING", 
      "description": "Error message if the translation failed.", 
      "optional": true 
    }
  },
  required: ["original_text", "translated_text_zh_TW", "source_language_code_detected"]
};


// SVG Icon Components
const TrashIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25V4.075c.827-.05 1.66-.075 2.5-.075zM7.443 16.669a1.25 1.25 0 01-1.226-1.244l-.81-10.124a.75.75 0 011.482-.23l.81 10.124a1.25 1.25 0 01-1.244 1.226zM12.557 16.67a1.25 1.25 0 01-1.244-1.227l.81-10.124a.75.75 0 011.482.23l-.81 10.124a1.25 1.25 0 01-1.226 1.244z" clipRule="evenodd" />
  </svg>
);
const SparklesIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clipRule="evenodd" />
  </svg>
);
const PlusCircleIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clipRule="evenodd" />
  </svg>
);
const MagnifyingGlassIcon = ({ className = "w-5 h-5" }) => ( 
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
  </svg>
);
const GlobeAltIcon = ({ className = "w-5 h-5" }) => ( 
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A11.978 11.978 0 0112 16.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 003 12c0 .778.099 1.533.284 2.253m0 0A11.978 11.978 0 0012 16.5c2.998 0 5.74-1.1 7.843-2.918" />
  </svg>
);
const CheckCircleIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clipRule="evenodd" />
  </svg>
);
const ChevronDownIcon = ({ className = "w-4 h-4 inline-block ml-1 transition-transform duration-200" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" />
  </svg>
);
const ChevronRightIcon = ({ className = "w-4 h-4 inline-block ml-1 transition-transform duration-200" }) => (
 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
  <path fillRule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" />
</svg>
);
const ArrowDownTrayIcon = ({ className = "w-5 h-5" }) => ( 
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
  </svg>
);


// Language mapping
const languageCodeToName = {
    'en': '英文',
    'fr': '法文',
    'ja': '日文',
    'ko': '韓文',
    'de': '德文',
    'es': '西班牙文',
    'it': '義大利文',
    'zh': '中文', 
};
const getLanguageName = (code) => languageCodeToName[code] || code || '未知語言';


// 主應用程式組件
function App() {
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  const [urlInput, setUrlInput] = useState('');
  const [currentArticleUrl, setCurrentArticleUrl] = useState('');
  const [articleText, setArticleText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isVocabLoading, setIsVocabLoading] = useState(false);
  const [isInsightLoading, setIsInsightLoading] = useState(false);
  const [isVerbConjLoading, setIsVerbConjLoading] = useState(false);
  const [isTranslating, setIsTranslating] = useState(false); 
  const [error, setError] = useState('');

  const [selectedText, setSelectedText] = useState('');
  const articleDisplayRef = useRef(null);
  const urlInputRef = useRef(null);

  const [bookmarks, setBookmarks] = useState([]);
  const [vocabulary, setVocabulary] = useState([]);
  const [articleInsights, setArticleInsights] = useState(null);
  const [verbToLookup, setVerbToLookup] = useState('');
  const [verbConjugationData, setVerbConjugationData] = useState(null);
  const [translationResult, setTranslationResult] = useState(null); 

  const [showModal, setShowModal] = useState(false);
  const [modalMessage, setModalMessage] = useState('');
  const [showTranslationModal, setShowTranslationModal] = useState(false); 

  const [detectedLanguage, setDetectedLanguage] = useState(''); 
  const [manualSelectedLanguage, setManualSelectedLanguage] = useState(''); 

  const [selectedInsightItems, setSelectedInsightItems] = useState({}); 
  const [verbDetailsOpenState, setVerbDetailsOpenState] = useState({}); 

  useEffect(() => {
    const styleId = 'google-font-gaegu-style';
    if (document.getElementById(styleId)) return;

    const style = document.createElement('style');
    style.id = styleId;
    style.innerHTML = `
      @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap');
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        background-color: #FDF6E3; 
        color: #58452D; 
      }
      .font-gaegu { 
        font-family: 'Gaegu', cursive;
      }
      .hand-drawn-border {
        border: 2px solid #A98C6A; 
        border-radius: 12px; 
        box-shadow: 3px 3px 0px #D5C4A1; 
      }
      .hand-drawn-button {
        font-family: 'Gaegu', cursive; 
        border: 2px solid #A98C6A;
        border-radius: 8px;
        box-shadow: 2px 2px 0px #D5C4A1;
        transition: all 0.1s ease-in-out;
      }
      .hand-drawn-button:hover {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0px #D5C4A1;
      }
      .hand-drawn-button:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }
      .prose-custom { 
        color: #58452D; 
        line-height: 1.8; 
      }
      .prose-custom p, .prose-custom li, .prose-custom strong, .prose-custom em {
        color: #58452D;
      }
       .prose-custom h1, .prose-custom h2, .prose-custom h3 {
        color: #8C6D46; 
        border-bottom: 2px dashed #A98C6A; 
        padding-bottom: 0.3em;
      }
      .section-title-gaegu {
        font-family: 'Gaegu', cursive;
      }
      details > summary {
        cursor: pointer;
        font-weight: bold;
        padding: 0.6em 0.85em; 
        background-color: #f0eade; 
        border-radius: 4px;
        margin-bottom: 0.4em; 
        border: 1px solid #d5c4a1;
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: background-color 0.2s ease-in-out;
      }
      details > summary:hover {
        background-color: #e8dcc8;
      }
      details[open] > summary {
        background-color: #e0d3bc;
      }
      details > div {
        padding: 0.85em 1.35em; 
        border: 1px dashed #d5c4a1; 
        border-top: none;
        border-radius: 0 0 4px 4px;
        background-color: #fdf9f0; 
      }
      .clickable-word {
        cursor: pointer;
        padding: 0.05em 0.15em; 
        border-radius: 3px;
        transition: background-color 0.2s;
      }
      .clickable-word:hover {
        background-color: #fee2b3; 
      }
      .clickable-word-selected {
        background-color: #fcd34d; 
        font-weight: bold;
      }
      .verb-mood-summary {
        background-color: #ede7f6 !important; 
        color: #5e35b1 !important; 
        border-bottom: 1px dashed #b39ddb !important; 
      }
      .verb-mood-summary:hover {
        background-color: #d1c4e9 !important; 
      }
      details[open] > .verb-mood-summary {
        background-color: #b39ddb !important; 
        color: #ffffff !important; 
      }
      .verb-tense-summary {
        background-color: #e3f2fd !important; 
        color: #1e88e5 !important; 
        font-size: 0.95em; 
        border-bottom: 1px dashed #90caf9 !important; 
        margin-left: 0.6rem; 
        margin-right: 0.6rem; 
      }
      .verb-tense-summary:hover {
        background-color: #bbdefb !important; 
      }
      details[open] > .verb-tense-summary {
        background-color: #90caf9 !important; 
        color: #0d47a1 !important; 
      }
      .verb-forms-list li { 
        padding: 0.35rem 0; 
        border-bottom: 1px dotted #e0e0e0; 
      }
      .verb-forms-list li:last-child {
        border-bottom: none; 
      }
      .verb-example-sentence { 
        margin-top: 0.85rem; 
        padding: 0.85rem; 
        background-color: #f5f5f5; 
        border-radius: 4px;
        border-left: 3px solid #7e57c2; 
        font-style: normal; 
      }
      .verb-example-sentence p {
         margin-bottom: 0.3rem; 
      }
    `;
    document.head.appendChild(style);
    return () => {
      const styleElement = document.getElementById(styleId);
      if (styleElement && styleElement.parentNode) {
        styleElement.parentNode.removeChild(styleElement);
      }
    };
  }, []);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth); 
          }
        } catch (e) {
          console.error("Firebase Auth Error: ", e);
          setError("認證失敗，部分功能可能無法使用。");
          setUserId('anonymous_' + Date.now()); 
        }
      }
      setIsAuthReady(true);
    });
    return () => unsubscribe(); 
  }, []);

  useEffect(() => {
    if (!isAuthReady || !userId) return; 

    // --- Firestore 索引重要提示 ---
    // 為了讓 orderBy("createdAt", "desc") 高效運作並避免 Firebase 在控制台中顯示警告/錯誤，
    // 請確保您已在 Firestore 資料庫中建立了相應的複合索引。
    //
    // 對於書籤 (bookmarks):
    //   集合路徑 (Collection Path): artifacts/{appId}/users/{userId}/languageLearnerBookmarks
    //   欄位 (Field): createdAt, 排序 (Order): 遞減 (Descending)
    //
    // 對於生字簿 (vocabulary):
    //   集合路徑 (Collection Path): artifacts/{appId}/users/{userId}/languageLearnerVocabulary
    //   欄位 (Field): createdAt, 排序 (Order): 遞減 (Descending)
    //
    // 如果索引缺失，Firebase 控制台通常會提供一個直接連結來幫助您建立這些索引。
    // --------------------------

    const bookmarksPath = `artifacts/${appId}/users/${userId}/languageLearnerBookmarks`;
    const bookmarksQuery = query(collection(db, bookmarksPath), orderBy("createdAt", "desc"));
    const unsubBookmarks = onSnapshot(bookmarksQuery, (snapshot) => {
      setBookmarks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => { 
      console.error("載入書籤時發生 Firestore 錯誤:", err); 
      setError(`無法載入書籤：${err.message}`); 
    });

    const vocabPath = `artifacts/${appId}/users/${userId}/languageLearnerVocabulary`;
    const vocabQuery = query(collection(db, vocabPath), orderBy("createdAt", "desc"));
    const unsubVocab = onSnapshot(vocabQuery, (snapshot) => {
      setVocabulary(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => { 
      console.error("載入生字簿時發生 Firestore 錯誤:", err); 
      setError(`無法載入生字簿：${err.message}`); 
    });
    
    return () => {
      unsubBookmarks();
      unsubVocab();
    };
  }, [isAuthReady, userId, appId]); // Added appId to dependency array as it's used in path

  const featureLanguage = manualSelectedLanguage || detectedLanguage;
  const featureLanguageName = getLanguageName(featureLanguage);

  const detectLanguageOfText = async (textToDetect) => {
    if (!textToDetect || textToDetect.trim().length < 20) { 
        console.warn("Text too short for reliable language detection or empty.");
        return 'unknown'; 
    }
    const snippet = textToDetect.substring(0, 500); 
    const prompt = `Detect the language of the following text. Respond ONLY with the two-letter ISO 639-1 language code (e.g., "en" for English, "fr" for French, "ja" for Japanese, "ko" for Korean, "de" for German, "es" for Spanish, "it" for Italian). Text: "${snippet}"`;
    try {
        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "無法解析語言偵測錯誤回應" }));
            console.error("Gemini API error for language detection:", errorData);
            throw new Error(`語言偵測失敗 (HTTP ${response.status}). ${errorData.error?.message || errorData.message || ''}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
            const langCode = result.candidates[0].content.parts[0].text.trim().toLowerCase().substring(0, 2); 
            const supportedCodes = Object.keys(languageCodeToName); 
            if (supportedCodes.includes(langCode)) {
                return langCode;
            } else {
                console.warn(`Detected language code "${langCode}" is not in the primary supported list or is unclear. Full response: ${result.candidates[0].content.parts[0].text}`);
                return 'unknown'; 
            }
        } else {
            console.error("Unexpected Gemini API response structure for language detection:", result);
            throw new Error("無法解析語言偵測回應。");
        }
    } catch (e) {
        console.error("Language detection error:", e);
        throw e; 
    }
};

  const handleFetchArticle = async () => {
    if (!urlInput.trim()) {
      setModalMessage("請輸入網址。");
      setShowModal(true);
      return;
    }
    setIsLoading(true); setError(''); setArticleText(''); setCurrentArticleUrl(''); setSelectedText('');
    setArticleInsights(null); setDetectedLanguage(''); setVerbConjugationData(null); setTranslationResult(null);
    setSelectedInsightItems({}); 
    setVerbDetailsOpenState({}); 
    
    try {
      const prompt = `Extract the main textual content from the following URL. Return the text in its original language. Preserve paragraph breaks if possible. Do not summarize or add any commentary. URL: ${urlInput}`;
      const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
      const payload = { contents: chatHistory };
      const apiKey = ""; 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) { 
        const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" }));
        console.error("Gemini API error for article fetch:", errorData);
        throw new Error(`無法從網址提取內容 (HTTP ${response.status})。${errorData.error?.message || errorData.message || ''}`); 
      }
      const result = await response.json();
      if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
        const fullArticleText = result.candidates[0].content.parts[0].text;
        setArticleText(fullArticleText);
        setCurrentArticleUrl(urlInput);

        try {
            const langCode = await detectLanguageOfText(fullArticleText);
            setDetectedLanguage(langCode); 
            if (!manualSelectedLanguage && (langCode === 'unknown' || !languageCodeToName[langCode])) {
                 setModalMessage(`成功提取文章內容，但無法明確偵測其語言 ("${getLanguageName(langCode)}")，或該語言目前未完全支援。部分 AI 功能可能表現不如預期。您也可以嘗試手動選擇語言。`);
                 setShowModal(true);
            } else if (manualSelectedLanguage && langCode !== manualSelectedLanguage && langCode !== 'unknown') {
                setModalMessage(`提醒：文章偵測到的語言為 ${getLanguageName(langCode)}，但您已手動選擇 ${getLanguageName(manualSelectedLanguage)}。相關功能將優先使用手動選擇的語言。`);
                setShowModal(true);
            }
        } catch (langDetectError) {
            console.error("Language detection failed after fetching article:", langDetectError);
            setError(prev => `${prev}\n語言偵測失敗: ${langDetectError.message}`); 
            setModalMessage(`文章提取成功，但語言偵測失敗：${langDetectError.message}。AI 功能可能受影響。請嘗試手動選擇語言。`);
            setShowModal(true);
            setDetectedLanguage('unknown'); 
        }

      } else { 
        console.error("Unexpected Gemini API response structure for article fetch:", result);
        throw new Error("無法解析提取的內容。回應格式不符預期。"); 
      }
    } catch (e) { 
      console.error("Fetch article error:", e);
      const errorMessage = `提取文章失敗：${e.message}`;
      setError(errorMessage);
      setModalMessage(errorMessage);
      setShowModal(true);
    } finally {
      setIsLoading(false);
    }
  };

  const handleChangeSource = () => {
    setUrlInput(''); setCurrentArticleUrl(''); setArticleText(''); setSelectedText(''); setError('');
    setArticleInsights(null);
    setDetectedLanguage(''); 
    setManualSelectedLanguage(''); 
    setVerbToLookup('');
    setVerbConjugationData(null);
    setTranslationResult(null);
    setSelectedInsightItems({}); 
    setVerbDetailsOpenState({}); 
    if (articleDisplayRef.current) articleDisplayRef.current.scrollTop = 0; 
    if (urlInputRef.current) urlInputRef.current.focus(); 
  };

  const handleTextSelection = () => {
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        if (articleDisplayRef.current && articleDisplayRef.current.contains(container) && 
            (!selection.anchorNode || !selection.anchorNode.parentElement.classList.contains('clickable-word'))) {
            const text = selection.toString().trim();
            if (text && text !== selectedText) setSelectedText(text); 
            else if (!text && selectedText) setSelectedText(''); 
        } else if (!articleDisplayRef.current || !articleDisplayRef.current.contains(container)) {
            if (selectedText) setSelectedText('');
        }
    } else {
        if (selectedText) setSelectedText(''); 
    }
  };

  const handleWordClick = (word) => {
    const cleanedWord = word.replace(/[.,!?;:"“”‘’()]$/g, '').trim(); 
    if (cleanedWord) {
      setSelectedText(cleanedWord); 
    }
  };
 
  const addBookmark = async () => {
    const langForBookmark = manualSelectedLanguage || detectedLanguage || 'unknown';
    if (!currentArticleUrl || !userId) { 
        setModalMessage("沒有可收藏的文章 URL 或使用者未登入。"); setShowModal(true); return; 
    }
    const existingBookmark = bookmarks.find(b => b.url === currentArticleUrl);
    if (existingBookmark) { 
        setModalMessage("這篇文章已經在您的收藏中了！"); setShowModal(true); return; 
    }
    const tempLoadingSetter = setIsLoading; 
    tempLoadingSetter(true); 
    try {
      const bookmarksCollectionPath = `artifacts/${appId}/users/${userId}/languageLearnerBookmarks`;
      const title = articleText.substring(0, 100) + (articleText.length > 100 ? '...' : '') || currentArticleUrl; 
      await addDoc(collection(db, bookmarksCollectionPath), {
        url: currentArticleUrl, 
        title: title, 
        detectedLanguage: detectedLanguage || 'unknown', 
        language: langForBookmark, 
        createdAt: serverTimestamp() 
      });
      setModalMessage("文章已成功收藏！"); setShowModal(true);
    } catch (e) { 
        console.error("Error adding bookmark:", e);
        const errorMessage = `收藏文章失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
    } finally { tempLoadingSetter(false); }
  };

  const removeBookmark = async (bookmarkId) => {
    if (!userId) return;
    const tempLoadingSetter = setIsLoading;
    tempLoadingSetter(true); 
    try {
      const bookmarkDocPath = `artifacts/${appId}/users/${userId}/languageLearnerBookmarks/${bookmarkId}`;
      await deleteDoc(doc(db, bookmarkDocPath));
      setModalMessage("收藏已移除。"); setShowModal(true);
    } catch (e) { 
        console.error("Error removing bookmark:", e);
        const errorMessage = `移除收藏失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
    } finally { tempLoadingSetter(false); }
  };

  const loadBookmarkedArticle = (url, lang) => { 
    setUrlInput(url); 
    setArticleText(''); 
    setCurrentArticleUrl(''); 
    setSelectedText(''); 
    setArticleInsights(null);
    setDetectedLanguage(''); 
    setManualSelectedLanguage(lang || ''); 
    setVerbToLookup('');
    setVerbConjugationData(null);
    setTranslationResult(null);
    setSelectedInsightItems({});
    setVerbDetailsOpenState({});
    setError('');
    setTimeout(() => handleFetchArticle(), 0); 
  };
 
  const addVocabEntry = async (term, definition_src_lang = '', translation_zh_TW = '', example_sentence_src_lang = '') => {
    const termToAdd = term || selectedText; 
    if (!termToAdd || !userId) { 
        setModalMessage("沒有選取的文字或使用者未登入。"); setShowModal(true); return false; 
    }
    if (!featureLanguage || featureLanguage === 'unknown' || !languageCodeToName[featureLanguage]) {
        setModalMessage(`無法確定有效語言 ("${featureLanguageName}")，無法加入生字簿。請先確認文章已正確載入並偵測到語言，或手動選擇一個有效語言。`);
        setShowModal(true);
        return false;
    }

    const existingVocab = vocabulary.find(v => v.word.toLowerCase() === termToAdd.toLowerCase() && v.language === featureLanguage);
    if (existingVocab) { 
        setModalMessage(`「${termToAdd}」(${featureLanguageName}) 已經在您的生字簿中了！`); setShowModal(true); return false; 
    }
    setIsVocabLoading(true); setError('');
    try {
      let vocabData = {
        definitions: definition_src_lang && typeof definition_src_lang === 'string' ? [definition_src_lang] : (Array.isArray(definition_src_lang) ? definition_src_lang : []),
        translation_zh_TW: translation_zh_TW || '',
        example_sentence: example_sentence_src_lang || '',
      };

      if (!definition_src_lang || !translation_zh_TW || !example_sentence_src_lang) {
        const currentLangNameForPrompt = getLanguageName(featureLanguage); 
        const prompt = `For the ${currentLangNameForPrompt} word or short phrase '${termToAdd}', provide: 
        1. Up to 2 common definitions in ${currentLangNameForPrompt}. 
        2. Its translation to Traditional Chinese. 
        3. One example sentence using the word/phrase in ${currentLangNameForPrompt}. 
        Respond ONLY with a JSON object matching this schema: { "definitions": ["definition1 in ${currentLangNameForPrompt}", "definition2 in ${currentLangNameForPrompt}"], "translation_zh_TW": "中文翻譯", "example_sentence": "Example sentence in ${currentLangNameForPrompt} here." }. 
        If it's not a valid word/phrase or you cannot provide this information, include an "error" field in your JSON response, like { "error": "Could not process." }.`;
        
        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: { responseMimeType: "application/json", responseSchema: vocabGenerationSchema }
        };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" }));
            throw new Error(`AI 查詢失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
          const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
          if (parsedResult.error) throw new Error(`AI 無法處理 「${termToAdd}」：${parsedResult.error}`);
          if (!parsedResult.definitions || !parsedResult.translation_zh_TW || !parsedResult.example_sentence) throw new Error(`AI 回應缺少必要資訊。`);
          vocabData = parsedResult; 
        } else throw new Error("AI 回應格式不符預期。");
      }

      const vocabCollectionPath = `artifacts/${appId}/users/${userId}/languageLearnerVocabulary`;
      await addDoc(collection(db, vocabCollectionPath), {
        word: termToAdd, 
        language: featureLanguage, 
        definitions: Array.isArray(vocabData.definitions) ? vocabData.definitions : [vocabData.definitions].filter(Boolean), 
        translation_zh_TW: vocabData.translation_zh_TW,
        example_sentence: vocabData.example_sentence,
        articleUrl: currentArticleUrl || 'general', 
        createdAt: serverTimestamp()
      });
      setModalMessage(`「${termToAdd}」 (${featureLanguageName}) 已成功加入生字簿！`); setShowModal(true);
      return true; 
    } catch (e) { 
        console.error("Error adding vocab entry:", e);
        const errorMessage = `加入生字簿失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
        return false; 
    } finally { setIsVocabLoading(false); }
  };

  const removeVocabEntry = async (vocabId) => {
    if (!userId) return;
    const tempLoadingSetter = setIsLoading; 
    tempLoadingSetter(true); 
    try {
      const vocabDocPath = `artifacts/${appId}/users/${userId}/languageLearnerVocabulary/${vocabId}`;
      await deleteDoc(doc(db, vocabDocPath));
      setModalMessage("生字已移除。"); setShowModal(true);
    } catch (e) { 
        console.error("Error removing vocab entry:", e);
        const errorMessage = `移除生字失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
    } finally { tempLoadingSetter(false); }
  };

  const getRenderedArticleText = useCallback(() => {
    if (!articleText && !isLoading) return <p className="text-stone-500 p-4">請輸入網址並點擊「讀取文章」以開始。</p>;
    if (isLoading && !articleText) return <p className="text-stone-500 p-4">正在努力讀取文章中...</p>;
    
    const lines = articleText.split('\n'); 
    return lines.map((line, lineIndex) => {
        const segments = line.split(/(\s+|[.,!?;:"“”‘’()])/g).filter(Boolean); 

        return (
            <p key={`line-${lineIndex}`} className="mb-4"> 
                {segments.map((segment, segmentIndex) => {
                    const isWhitespaceOrPunctuation = /^\s+$|^[.,!?;:"“”‘’()]$/.test(segment);
                    
                    if (isWhitespaceOrPunctuation) {
                        return <React.Fragment key={`segment-ws-${lineIndex}-${segmentIndex}`}>{segment}</React.Fragment>;
                    }
                    
                    const isSelectedWord = selectedText === segment && segment !== '';

                    return (
                        <span
                            key={`word-${lineIndex}-${segmentIndex}`}
                            className={`clickable-word ${isSelectedWord ? 'clickable-word-selected' : ''}`}
                            onClick={() => handleWordClick(segment)} 
                        >
                            {segment}
                        </span>
                    );
                })}
            </p>
        );
    });
  }, [articleText, isLoading, selectedText]); 

  const handleFetchArticleInsights = async () => {
    if (!articleText || !userId) { 
        setModalMessage("沒有文章內容或使用者未登入。"); setShowModal(true); return; 
    }
    if (!featureLanguage || featureLanguage === 'unknown' || !languageCodeToName[featureLanguage]) {
        setModalMessage(`無法確定有效語言 ("${featureLanguageName}")，無法進行深度分析。`);
        setShowModal(true);
        return;
    }
    setIsInsightLoading(true); setError(''); setArticleInsights(null); setSelectedInsightItems({}); 
    try {
      const currentLangNameForPrompt = getLanguageName(featureLanguage);
      const prompt = `請分析以下${currentLangNameForPrompt}文章，並提供學習洞察。文章內容如下：\n\n"${articleText}"\n\n請嚴格依照以下JSON格式回傳，包含重點單字、實用片語和文法結構亮點。
      - 對於「重點單字」(key_vocabulary):
          - "word": The vocabulary word in ${currentLangNameForPrompt}.
          - "definition_en": Concise definition of the word in ${currentLangNameForPrompt}. (Even though field name is _en, provide in ${currentLangNameForPrompt})
          - "translation_zh_TW": Traditional Chinese translation of the word.
          - "example_sentence_from_article": The exact sentence from the article in ${currentLangNameForPrompt} containing the word.
      - 對於「實用片語」(useful_phrases):
          - "phrase": The phrase or idiom in ${currentLangNameForPrompt}.
          - "meaning_en": Concise meaning of the phrase in ${currentLangNameForPrompt}. (Even though field name is _en, provide in ${currentLangNameForPrompt})
          - "translation_zh_TW": Traditional Chinese translation of the phrase.
          - "example_sentence_from_article": The exact sentence from the article in ${currentLangNameForPrompt} containing the phrase.
      - 對於「文法結構亮點」(grammar_highlights):
          - "grammar_point_name_zh_TW": Name of the grammar point in Traditional Chinese (e.g., '${currentLangNameForPrompt}的過去完成式', '${currentLangNameForPrompt}的被動語態').
          - "explanation_zh_TW": Brief (1-2 sentences) explanation of the grammar rule in Traditional Chinese, focusing on its use in the example from the ${currentLangNameForPrompt} article.
          - "example_sentence_from_article": The exact sentence from the ${currentLangNameForPrompt} article showcasing this grammar point.`;

      const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
      const payload = {
        contents: chatHistory,
        generationConfig: { responseMimeType: "application/json", responseSchema: insightGenerationSchema }
      };
      const apiKey = ""; 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" }));
        console.error("Gemini API error for insights:", errorData);
        throw new Error(`AI 深度分析失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
      }
      const result = await response.json();
      if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
        const insightsData = JSON.parse(result.candidates[0].content.parts[0].text);
        if (insightsData && insightsData.key_vocabulary && insightsData.useful_phrases && insightsData.grammar_highlights) {
            setArticleInsights(insightsData);
        } else {
            console.error("AI 深度分析回應 JSON 結構不完整:", insightsData);
            throw new Error("AI 深度分析回應的資料結構不完整。");
        }
      } else { 
        console.error("Unexpected Gemini API response structure for insights:", result);
        throw new Error("AI 深度分析回應格式不符預期。"); 
      }
    } catch (e) { 
        console.error("Error fetching article insights:", e);
        const errorMessage = `AI 深度分析失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
    } finally { setIsInsightLoading(false); }
  };

  const handleToggleInsightItemSelection = (itemKey) => { 
    setSelectedInsightItems(prev => ({ 
      ...prev,
      [itemKey]: !prev[itemKey] 
    }));
  };

  const handleBulkAddSelectedInsightItems = async () => { 
    const vocabItemsToAdd = articleInsights?.key_vocabulary?.filter(item => selectedInsightItems[item.word]) || [];
    const phraseItemsToAdd = articleInsights?.useful_phrases?.filter(item => selectedInsightItems[item.phrase]) || [];

    if (vocabItemsToAdd.length === 0 && phraseItemsToAdd.length === 0) {
      setModalMessage("請先勾選要加入的單字或片語。");
      setShowModal(true);
      return;
    }

    setIsVocabLoading(true); 
    let successCount = 0;
    let alreadyExistsCount = 0;
    let errorCount = 0;

    for (const item of vocabItemsToAdd) {
      const existingVocab = vocabulary.find(v => v.word.toLowerCase() === item.word.toLowerCase() && v.language === featureLanguage);
      if (existingVocab) {
        alreadyExistsCount++;
        continue; 
      }
      const added = await addVocabEntry(item.word, item.definition_en, item.translation_zh_TW, item.example_sentence_from_article);
      if (added) {
        successCount++;
      } else {
        errorCount++; 
      }
    }

    for (const item of phraseItemsToAdd) {
      const existingVocab = vocabulary.find(v => v.word.toLowerCase() === item.phrase.toLowerCase() && v.language === featureLanguage);
      if (existingVocab) {
        alreadyExistsCount++;
        continue;
      }
      const added = await addVocabEntry(item.phrase, item.meaning_en, item.translation_zh_TW, item.example_sentence_from_article);
      if (added) {
        successCount++;
      } else {
        errorCount++;
      }
    }

    setIsVocabLoading(false);

    let summaryMessage = `批次加入完成：\n- ${successCount} 個新項目 (單字/片語) 成功加入。\n- ${alreadyExistsCount} 個項目已存在生字簿中。`;
    if (errorCount > 0) {
      summaryMessage += `\n- ${errorCount} 個項目加入失敗 (詳見先前錯誤訊息)。`;
    }
    setModalMessage(summaryMessage);
    setShowModal(true);
    setSelectedInsightItems({}); 
  };


  const handleFetchVerbConjugation = async () => {
    if (!verbToLookup.trim()) {
        setModalMessage("請輸入要查詢的動詞。"); setShowModal(true); return;
    }
    if (!featureLanguage || featureLanguage === 'unknown' || !languageCodeToName[featureLanguage]) {
        setModalMessage(`無法確定有效語言 ("${featureLanguageName}")，無法查詢動詞變化。請先載入文章並確認語言，或手動選擇一個有效語言。`);
        setShowModal(true);
        return;
    }
    setIsVerbConjLoading(true); setError(''); setVerbConjugationData(null); setVerbDetailsOpenState({}); 
    try {
        const currentLangNameForPrompt = getLanguageName(featureLanguage);
        const prompt = `You are a linguistics expert specializing in verb conjugations. The user wants to understand how the ${currentLangNameForPrompt} verb '${verbToLookup}' is conjugated. The language code for ${currentLangNameForPrompt} is '${featureLanguage}'.
Please provide a detailed conjugation for the verb.
Respond ONLY with a JSON object adhering to the schema provided in the 'generationConfig.responseSchema'.
Key instructions for the JSON content:
- 'language_code_provided': This should be '${featureLanguage}'.
- 'verb_infinitive_src_lang': The infinitive (base) form of '${verbToLookup}' in ${currentLangNameForPrompt}.
- 'language_name_for_display_zh_TW': This should be '${currentLangNameForPrompt}'.
- 'regularity_zh_TW': Describe if the verb is regular or irregular in Traditional Chinese (e.g., '規則動詞', '不規則動詞').
- 'verb_type_zh_TW': Specify the type of verb in Traditional Chinese (e.g., '主要動詞', '助動詞', '情態動詞'). If not applicable or unknown, you can state '不適用' or omit the field if schema allows.
- 'conjugations': This is an array. Each item represents a major conjugation category, usually a mood.
  - 'group_name_src_lang': The name of this category (e.g., mood like 'Indicatif', 'Subjonctif') in ${currentLangNameForPrompt}. This is optional but preferred.
  - 'group_name_zh_TW': The name of this category in Traditional Chinese (e.g., '直陳式', '假設式').
  - 'tenses_or_voices': This is an array. Each item represents a sub-category, typically a tense or a voice within the main group.
    - 'sub_group_name_src_lang': The name of this sub-category (e.g., tense like 'Présent', 'Passé composé'; voice like 'Active Voice') in ${currentLangNameForPrompt}. Optional but preferred.
    - 'sub_group_name_zh_TW': The name of this sub-category in Traditional Chinese (e.g., '現在時', '複合過去時'; '主動態').
    - 'forms': This is an array of conjugated forms.
      - 'person_descriptor_src_lang': The person/number identifier, ideally the pronoun in ${currentLangNameForPrompt} (e.g., for French: 'Je', 'Tu', 'Il/Elle/On', 'Nous', 'Vous', 'Ils/Elles'; for English: 'I', 'You', 'He/She/It', 'We', 'They'). If specific pronouns are not standard for listing (e.g., for Japanese), use a general descriptor in ${currentLangNameForPrompt} or a Traditional Chinese descriptor like '第一人稱單數'.
      - 'conjugated_form_src_lang': The actual conjugated verb form in ${currentLangNameForPrompt}.
    - 'example_sentence_src_lang': An example sentence in ${currentLangNameForPrompt} that uses one of the forms from this sub-group. This is optional.
    - 'example_sentence_translation_zh_TW': The Traditional Chinese translation of the example sentence. This is optional.
- 'notes_zh_TW': Any additional relevant notes about the verb's conjugation, usage, or irregularities, in Traditional Chinese. This is optional.
If the verb '${verbToLookup}' is invalid for ${currentLangNameForPrompt}, cannot be found, or if you cannot provide the conjugation information as requested, your JSON response should include an 'error' field explaining the issue (e.g., { 'error': '無法處理此動詞或在${currentLangNameForPrompt}中找不到此動詞。' }). Ensure the rest of the main required fields are still present if possible, perhaps with placeholder or 'N/A' values if the error is partial.`;

        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
            contents: chatHistory,
            generationConfig: { responseMimeType: "application/json", responseSchema: verbConjugationSchema }
        };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "無法解析動詞變化錯誤回應" }));
            console.error("Gemini API error for verb conjugation:", errorData);
            throw new Error(`AI 動詞變化查詢失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
            const conjugationResult = JSON.parse(result.candidates[0].content.parts[0].text);
            if (conjugationResult.error) {
                setModalMessage(`AI 無法處理動詞「${verbToLookup}」(${currentLangNameForPrompt})：${conjugationResult.error}`);
                setShowModal(true);
                setVerbConjugationData({ error: conjugationResult.error, verb_infinitive_src_lang: verbToLookup, language_name_for_display_zh_TW: currentLangNameForPrompt });
            } else if (conjugationResult.conjugations) {
                setVerbConjugationData(conjugationResult);
                const initialOpenState = {};
                conjugationResult.conjugations.forEach((mood, moodIndex) => {
                    initialOpenState[`mood-${moodIndex}`] = moodIndex === 0; 
                    mood.tenses_or_voices.forEach((tense, tenseIndex) => {
                        initialOpenState[`mood-${moodIndex}-tense-${tenseIndex}`] = moodIndex === 0 && tenseIndex === 0; 
                    });
                });
                setVerbDetailsOpenState(initialOpenState);

            } else {
                 throw new Error("AI 動詞變化回應缺少必要資訊 (conjugations)。");
            }
        } else {
            console.error("Unexpected Gemini API response structure for verb conjugation:", result);
            throw new Error("AI 動詞變化回應格式不符預期。");
        }
    } catch (e) {
        console.error("Error fetching verb conjugation:", e);
        const errorMessage = `查詢動詞變化失敗：${e.message}`;
        setError(errorMessage);
        setModalMessage(errorMessage);
        setShowModal(true);
        setVerbConjugationData({ error: errorMessage, verb_infinitive_src_lang: verbToLookup, language_name_for_display_zh_TW: getLanguageName(featureLanguage) });
    } finally {
        setIsVerbConjLoading(false);
    }
};

const toggleVerbDetailOpenState = (key) => {
    setVerbDetailsOpenState(prev => ({ ...prev, [key]: !prev[key] }));
};

const setAllVerbDetailsOpenState = (isOpen) => {
    if (!verbConjugationData || !verbConjugationData.conjugations) return; 
    const newState = {};
    verbConjugationData.conjugations.forEach((mood, moodIndex) => {
        const moodKey = `mood-${moodIndex}`;
        newState[moodKey] = isOpen;
        mood.tenses_or_voices.forEach((tense, tenseIndex) => {
            const tenseKey = `${moodKey}-tense-${tenseIndex}`;
            newState[tenseKey] = isOpen;
        });
    });
    setVerbDetailsOpenState(newState);
};


const handleTranslateSelectedText = async () => {
    if (!selectedText) {
        setModalMessage("請先在文章中選取一些文字。"); setShowModal(true); return;
    }
    if (!featureLanguage || featureLanguage === 'unknown' || !languageCodeToName[featureLanguage]) {
        setModalMessage(`無法確定有效來源語言 ("${featureLanguageName}")，無法進行翻譯。`);
        setShowModal(true);
        return;
    }
    setIsTranslating(true); setError(''); setTranslationResult(null);
    try {
        const sourceLangName = getLanguageName(featureLanguage);
        const prompt = `Please translate the following text from ${sourceLangName} (language code: ${featureLanguage}) to Traditional Chinese (target language code: zh-TW).
Original Text: "${selectedText}"
Respond ONLY with a JSON object adhering to this schema: ${JSON.stringify(translationSchema)}.
If translation is not possible or an error occurs, include an "error" field in your JSON.`;

        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
            contents: chatHistory,
            generationConfig: { responseMimeType: "application/json", responseSchema: translationSchema }
        };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "無法解析翻譯錯誤回應" }));
            console.error("Gemini API error for translation:", errorData);
            throw new Error(`AI 翻譯失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
            const translationData = JSON.parse(result.candidates[0].content.parts[0].text);
            if (translationData.error) {
                throw new Error(`AI 翻譯時發生錯誤：${translationData.error}`);
            }
            setTranslationResult(translationData);
            setShowTranslationModal(true); 
        } else {
            console.error("Unexpected Gemini API response structure for translation:", result);
            throw new Error("AI 翻譯回應格式不符預期。");
        }
    } catch (e) {
        console.error("Error translating text:", e);
        const errorMessage = `翻譯失敗：${e.message}`;
        setError(errorMessage); 
        setModalMessage(errorMessage); 
        setShowModal(true);
    } finally {
        setIsTranslating(false);
    }
};

  const filteredBookmarks = manualSelectedLanguage 
    ? bookmarks.filter(b => b.language === manualSelectedLanguage) 
    : bookmarks; 
  const filteredVocabulary = manualSelectedLanguage 
    ? vocabulary.filter(v => v.language === manualSelectedLanguage) 
    : vocabulary; 

  // Helper function to escape CSV data
  const escapeCsvCell = (cellData) => {
    if (cellData === null || typeof cellData === 'undefined') return '';
    let cellString = String(cellData);
    if (cellString.includes(',') || cellString.includes('"') || cellString.includes('\n')) {
      cellString = cellString.replace(/"/g, '""');
      return `"${cellString}"`;
    }
    return cellString;
  };

  const exportVocabularyToCSV = () => {
    if (filteredVocabulary.length === 0) {
      setModalMessage("生字簿是空的，沒有內容可以匯出。");
      setShowModal(true);
      return;
    }

    const headers = ["詞條", "語言", "定義/意思 (原文)", "翻譯 (繁中)", "例句 (原文)", "文章來源URL"]; 
    const csvRows = [headers.join(',')]; 

    filteredVocabulary.forEach(v => {
      const definitions = Array.isArray(v.definitions) ? v.definitions.join('; ') : (v.definitions || '');
      const row = [
        escapeCsvCell(v.word), 
        escapeCsvCell(getLanguageName(v.language)),
        escapeCsvCell(definitions), 
        escapeCsvCell(v.translation_zh_TW),
        escapeCsvCell(v.example_sentence),
        escapeCsvCell(v.articleUrl)
      ];
      csvRows.push(row.join(','));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' }); 
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `我的生字簿_${featureLanguageName || '所有語言'}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setModalMessage("生字簿已成功匯出為 CSV 檔案！");
    setShowModal(true);
  };

  const exportVerbConjugationToCSV = () => {
    if (!verbConjugationData || verbConjugationData.error || !verbConjugationData.conjugations) {
      setModalMessage("沒有動詞變化資料可供匯出，或資料有誤。");
      setShowModal(true);
      return;
    }

    const headers = ["語氣 (原文)", "語氣 (繁中)", "時態/語態 (原文)", "時態/語態 (繁中)", "人稱/編號 (原文)", "變化形 (原文)", "例句 (原文)", "例句翻譯 (繁中)"];
    const csvRows = [headers.join(',')];

    verbConjugationData.conjugations.forEach(mood => {
      mood.tenses_or_voices.forEach(tense => {
        tense.forms.forEach(form => {
          const row = [
            escapeCsvCell(mood.group_name_src_lang),
            escapeCsvCell(mood.group_name_zh_TW),
            escapeCsvCell(tense.sub_group_name_src_lang),
            escapeCsvCell(tense.sub_group_name_zh_TW),
            escapeCsvCell(form.person_descriptor_src_lang),
            escapeCsvCell(form.conjugated_form_src_lang),
            escapeCsvCell(tense.example_sentence_src_lang),
            escapeCsvCell(tense.example_sentence_translation_zh_TW)
          ];
          csvRows.push(row.join(','));
        });
        if (tense.forms.length === 0 && tense.example_sentence_src_lang) {
            const row = [
                escapeCsvCell(mood.group_name_src_lang),
                escapeCsvCell(mood.group_name_zh_TW),
                escapeCsvCell(tense.sub_group_name_src_lang),
                escapeCsvCell(tense.sub_group_name_zh_TW),
                '', 
                '', 
                escapeCsvCell(tense.example_sentence_src_lang),
                escapeCsvCell(tense.example_sentence_translation_zh_TW)
            ];
            csvRows.push(row.join(','));
        }
      });
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    const verbName = verbConjugationData?.verb_infinitive_src_lang || '動詞變化'; 
    const langName = verbConjugationData?.language_name_for_display_zh_TW || featureLanguageName; 
    link.setAttribute("href", url);
    link.setAttribute("download", `${verbName}_${langName}_變化表_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setModalMessage(`動詞「${verbName}」(${langName}) 的變化表已成功匯出為 CSV 檔案！`);
    setShowModal(true);
  };


  if (!isAuthReady) {
    return <div className="flex justify-center items-center h-screen text-2xl font-bold font-gaegu" style={{ color: '#58452D' }}>正在初始化應用程式...</div>;
  }

  const anyLoading = isLoading || isVocabLoading || isInsightLoading || isVerbConjLoading || isTranslating;
  const numSelectedInsightItems = Object.values(selectedInsightItems).filter(Boolean).length; 

  return (
    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#FDF6E3' }}>
      <header className="mb-10 p-7 hand-drawn-border bg-orange-100"> 
        <h1 className="text-4xl md:text-5xl font-bold text-center font-gaegu mb-2" style={{ color: '#8C6D46' }}>語言學習小幫手</h1> 
        {userId && <p className="text-sm text-center mt-2" style={{color: '#A98C6A'}}>使用者 ID: {userId}</p>}
      </header>

      <section className="mb-8 p-7 hand-drawn-border bg-lime-50"> 
        <div className="grid grid-cols-1 sm:grid-cols-12 gap-6 items-center"> {/* Increased gap to gap-6 */}
          <input
            ref={urlInputRef} 
            type="url"
            value={urlInput}
            onChange={(e) => setUrlInput(e.target.value)}
            placeholder="貼上文章網址開始學習..."
            className="sm:col-span-6 p-4 hand-drawn-border bg-white text-lg focus:ring-2 focus:ring-orange-300 outline-none" 
            disabled={anyLoading}
          />
          <select
            value={manualSelectedLanguage}
            onChange={(e) => {
                setManualSelectedLanguage(e.target.value);
                if (e.target.value && detectedLanguage && e.target.value !== detectedLanguage) {
                    setModalMessage(`功能語言已手動設定為 ${getLanguageName(e.target.value)}。文章偵測語言為 ${getLanguageName(detectedLanguage)}。`);
                    setShowModal(true);
                } else if (!e.target.value && detectedLanguage) { 
                     setModalMessage(`功能語言已切換回自動偵測 (${getLanguageName(detectedLanguage) || '未偵測到'})。`);
                     setShowModal(true);
                }
            }}
            className="sm:col-span-3 p-4 hand-drawn-border bg-white text-lg focus:ring-2 focus:ring-orange-300 outline-none" 
            disabled={anyLoading}
          >
            <option value="">自動偵測語言</option>
            {Object.entries(languageCodeToName).map(([code, name]) => (
              <option key={code} value={code}>{name}</option>
            ))}
          </select>
          <button
            onClick={handleFetchArticle}
            disabled={anyLoading}
            className="sm:col-span-2 px-7 py-4 hand-drawn-button bg-sky-200 hover:bg-sky-300 text-sky-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed whitespace-nowrap" 
          >
            {isLoading ? '讀取中...' : '讀取文章'}
          </button>
          <button
            onClick={handleChangeSource}
            disabled={anyLoading}
            className="sm:col-span-1 px-7 py-4 hand-drawn-button bg-stone-200 hover:bg-stone-300 text-stone-700 font-semibold text-lg whitespace-nowrap disabled:opacity-60 disabled:cursor-not-allowed" 
          >
            換一篇
          </button>
        </div>
      </section>

      <div className="flex flex-col lg:flex-row gap-10"> 
        <main className="lg:w-2/3 p-7 hand-drawn-border bg-white flex flex-col"> 
          <h2 className="text-3xl font-bold mb-5 pb-4 section-title-gaegu" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>文章內容</h2>  {/* Adjusted mb */}
          
          <div className="text-sm text-center my-5 space-y-1.5" style={{color: '#A98C6A'}}> {/* Adjusted my */}
            {currentArticleUrl && detectedLanguage && (
                <p>偵測到的文章語言：<span className="font-semibold">{getLanguageName(detectedLanguage) || '未知'}</span>
                { (detectedLanguage === 'unknown' || !languageCodeToName[detectedLanguage]) && " (部分 AI 功能可能受限)"}
                </p>
            )}
            {manualSelectedLanguage && (
                <p>手動篩選/功能語言：<span className="font-semibold">{getLanguageName(manualSelectedLanguage)}</span></p>
            )}
          </div>

          {isLoading && currentArticleUrl && <p className="p-4 text-orange-600">正在載入文章「{currentArticleUrl}」...</p>}
          <div
            ref={articleDisplayRef}
            onMouseUp={handleTextSelection} 
            onTouchEnd={handleTextSelection} 
            className="prose-custom max-w-none h-96 overflow-y-auto p-5 border border-dashed border-stone-300 rounded-md bg-orange-50/50" 
            style={{ userSelect: 'text', fontSize: '1.1rem' }} 
          >
            {getRenderedArticleText()}
          </div>

          {currentArticleUrl && !articleInsights && !isInsightLoading && articleText && featureLanguage && languageCodeToName[featureLanguage] && (
            <button
              onClick={handleFetchArticleInsights}
              disabled={anyLoading}
              className="mt-8 px-7 py-3.5 hand-drawn-button bg-teal-200 hover:bg-teal-300 text-teal-800 font-semibold text-lg self-center inline-flex items-center gap-2.5 disabled:opacity-60 disabled:cursor-not-allowed" 
            >
              <SparklesIcon className="w-5 h-5" />
              深度學習分析 ({featureLanguageName})
            </button>
          )}
          {isInsightLoading && ( 
            <div className="mt-8 p-5 text-center text-teal-700"> 
              <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-teal-500 mx-auto mb-3"></div> 
              AI 努力分析中 ({featureLanguageName})，請稍候...
            </div>
          )}
          {articleInsights && (
            <div className="mt-10 pt-8 border-t-2 border-dashed border-stone-300"> 
              <div className="flex justify-between items-center mb-8"> 
                <h3 className="text-2xl font-bold section-title-gaegu" style={{ color: '#8C6D46' }}>AI 學習洞察 ({featureLanguageName})</h3>
                {(articleInsights.key_vocabulary?.length > 0 || articleInsights.useful_phrases?.length > 0) && (
                    <button
                        onClick={handleBulkAddSelectedInsightItems}
                        disabled={anyLoading || numSelectedInsightItems === 0}
                        className="hand-drawn-button bg-green-200 hover:bg-green-300 text-green-800 text-sm px-4 py-2 inline-flex items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed" 
                        title="批次加入已勾選的單字與片語"
                    >
                        <CheckCircleIcon className="w-4 h-4" /> 批次加入 ({numSelectedInsightItems})
                    </button>
                )}
              </div>
              
              <div className="mb-10">  
                <h4 className="text-xl font-semibold mb-5 pb-1.5 section-title-gaegu" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>重點單字</h4> 
                {articleInsights.key_vocabulary && articleInsights.key_vocabulary.length > 0 ? (
                  <ul className="space-y-6"> 
                    {articleInsights.key_vocabulary.map((item, index) => (
                      <li key={`vocab-${item.word}-${index}`} className="p-5 hand-drawn-border bg-amber-50/70 text-sm">  
                        <div className="flex justify-between items-start mb-1.5"> {/* Adjusted mb */}
                            <div className="flex items-center">
                                <input 
                                    type="checkbox"
                                    id={`insight-vocab-${index}`}
                                    checked={!!selectedInsightItems[item.word]} 
                                    onChange={() => handleToggleInsightItemSelection(item.word)} 
                                    className="mr-3.5 h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 cursor-pointer" 
                                    disabled={anyLoading}
                                />
                                <label htmlFor={`insight-vocab-${index}`} className="cursor-pointer">
                                    <strong className="text-lg text-amber-700 block mb-2">{item.word}</strong>  
                                </label>
                            </div>
                          <button 
                            onClick={() => addVocabEntry(item.word, item.definition_en, item.translation_zh_TW, item.example_sentence_from_article)}
                            disabled={anyLoading || !featureLanguage || !languageCodeToName[featureLanguage]}
                            className="hand-drawn-button bg-green-100 hover:bg-green-200 text-green-700 text-xs px-3 py-2 inline-flex items-center gap-1.5 disabled:opacity-60 disabled:cursor-not-allowed" 
                            title="單獨加入此單字"
                          >
                            <PlusCircleIcon className="w-4 h-4"/> 加入
                          </button>
                        </div>
                        <p className="mt-2 mb-2"><span className="font-semibold text-stone-500">定義 ({featureLanguageName || '原文'}):</span> {item.definition_en}</p> {/* Adjusted mt, mb */}
                        <p className="mb-2"><span className="font-semibold text-stone-500">翻譯 (繁中):</span> {item.translation_zh_TW}</p> {/* Adjusted mb */}
                        <p className="mt-2.5 italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句 ({featureLanguageName || '原文'}):</span> "{item.example_sentence_from_article}"</p>  
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500 pt-3">AI 未找到特別的重點單字。</p>} 
              </div>

              <div className="mb-10"> 
                <h4 className="text-xl font-semibold mb-5 pb-1.5 section-title-gaegu" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>實用片語</h4> 
                {articleInsights.useful_phrases && articleInsights.useful_phrases.length > 0 ? (
                  <ul className="space-y-6"> 
                    {articleInsights.useful_phrases.map((item, index) => (
                      <li key={`phrase-${item.phrase}-${index}`} className="p-5 hand-drawn-border bg-sky-50/70 text-sm"> 
                         <div className="flex justify-between items-start mb-1.5"> {/* Adjusted mb */}
                            <div className="flex items-center">
                                <input 
                                    type="checkbox"
                                    id={`insight-phrase-${index}`}
                                    checked={!!selectedInsightItems[item.phrase]} 
                                    onChange={() => handleToggleInsightItemSelection(item.phrase)} 
                                    className="mr-3.5 h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 cursor-pointer" 
                                    disabled={anyLoading}
                                />
                                <label htmlFor={`insight-phrase-${index}`} className="cursor-pointer">
                                    <strong className="text-lg text-sky-700 block mb-2">{item.phrase}</strong> 
                                </label>
                            </div>
                          <button 
                            onClick={() => addVocabEntry(item.phrase, item.meaning_en, item.translation_zh_TW, item.example_sentence_from_article)}
                            disabled={anyLoading || !featureLanguage || !languageCodeToName[featureLanguage]}
                            className="hand-drawn-button bg-green-100 hover:bg-green-200 text-green-700 text-xs px-3 py-2 inline-flex items-center gap-1.5 disabled:opacity-60 disabled:cursor-not-allowed" 
                            title="單獨加入此片語"
                          >
                            <PlusCircleIcon className="w-4 h-4"/> 加入
                          </button>
                        </div>
                        <p className="mb-2"><span className="font-semibold text-stone-500">意思 ({featureLanguageName || '原文'}):</span> {item.meaning_en}</p> {/* Adjusted mb */}
                        <p className="mb-2"><span className="font-semibold text-stone-500">翻譯 (繁中):</span> {item.translation_zh_TW}</p> {/* Adjusted mb */}
                        <p className="mt-2.5 italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句 ({featureLanguageName || '原文'}):</span> "{item.example_sentence_from_article}"</p> 
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500 pt-3">AI 未找到特別的實用片語。</p>} 
              </div>

              <div>
                <h4 className="text-xl font-semibold mb-5 pb-1.5 section-title-gaegu" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>文法結構亮點</h4> 
                {articleInsights.grammar_highlights && articleInsights.grammar_highlights.length > 0 ? (
                  <ul className="space-y-6"> 
                    {articleInsights.grammar_highlights.map((item, index) => (
                      <li key={`grammar-${item.grammar_point_name_zh_TW.replace(/\s/g, '_')}-${index}`} className="p-5 hand-drawn-border bg-purple-50/70 text-sm"> 
                        <strong className="text-lg text-purple-700 block mb-2">{item.grammar_point_name_zh_TW}</strong> 
                        <p className="mb-2"><span className="font-semibold text-stone-500">解釋 (繁中):</span> {item.explanation_zh_TW}</p> 
                        <p className="italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句 ({featureLanguageName || '原文'}):</span> "{item.example_sentence_from_article}"</p>
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500 pt-3">AI 未找到特別的文法亮點。</p>} 
              </div>
            </div>
          )}
        </main>

        <aside className="lg:w-1/3 flex flex-col gap-10"> 
          <section className="p-7 hand-drawn-border bg-amber-50"> 
            <h3 className="text-2xl font-bold mb-6 pb-2.5 section-title-gaegu" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>學習工具</h3> 
            {currentArticleUrl && articleText && (
              <button
                onClick={addBookmark}
                disabled={anyLoading || !currentArticleUrl}
                className="w-full mb-5 px-5 py-3.5 hand-drawn-button bg-green-200 hover:bg-green-300 text-green-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed" 
              >
                收藏這篇文章
              </button>
            )}
            {selectedText && articleText && featureLanguage && languageCodeToName[featureLanguage] && (
              <>
                <button
                  onClick={() => addVocabEntry(selectedText)} 
                  disabled={anyLoading || !selectedText}
                  className="w-full mb-5 px-5 py-3.5 hand-drawn-button bg-purple-200 hover:bg-purple-300 text-purple-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed" 
                >
                  {isVocabLoading && selectedText === (document.activeElement?.dataset?.word || '') ? '查詢中...' : `加入生字簿 (${featureLanguageName}): "${selectedText.substring(0,10)}..."`}
                </button>
                <button
                  onClick={handleTranslateSelectedText}
                  disabled={anyLoading || !selectedText}
                  className="w-full px-5 py-3.5 hand-drawn-button bg-blue-200 hover:bg-blue-300 text-blue-800 font-semibold text-lg inline-flex items-center justify-center gap-2.5 disabled:opacity-60 disabled:cursor-not-allowed" 
                >
                  <GlobeAltIcon className="w-5 h-5" />
                  {isTranslating ? '翻譯中...' : `翻譯選取文字 (至繁中)`}
                </button>
              </>
            )}
            {!selectedText && articleText && (
              <p className="text-sm text-stone-500 mt-4">在文章中選取或點擊文字以加入生字簿或翻譯。</p> 
            )}
             {articleText && (!featureLanguage || !languageCodeToName[featureLanguage]) && (
               <p className="text-sm text-orange-600 mt-4">請確認已偵測到或手動選擇有效語言以使用工具。</p> 
            )}
            {!articleText && (
              <p className="text-sm text-stone-500 mt-4">請先讀取一篇文章以使用工具。</p> 
            )}
          </section>
          
          <section className="p-7 hand-drawn-border bg-indigo-50"> 
            <div className="flex justify-between items-center mb-6"> 
                <h3 className="text-2xl font-bold pb-2.5 section-title-gaegu" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>動詞變化查詢 ({featureLanguageName || '請選語言'})</h3> 
                {verbConjugationData && !verbConjugationData.error && verbConjugationData.conjugations && (
                    <button
                        onClick={exportVerbConjugationToCSV}
                        disabled={anyLoading}
                        className="hand-drawn-button bg-indigo-200 hover:bg-indigo-300 text-indigo-800 text-sm px-3.5 py-2 inline-flex items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed" 
                        title="匯出動詞變化表 (CSV)"
                    >
                        <ArrowDownTrayIcon className="w-4 h-4" /> 匯出
                    </button>
                )}
            </div>
            {(!featureLanguage || !languageCodeToName[featureLanguage]) && ( 
                 <p className="text-sm text-stone-500 mb-4">請先成功載入文章並偵測語言，或手動選擇一個支援的語言。</p> 
            )}
            {featureLanguage && languageCodeToName[featureLanguage] && ( 
                <>
                    <div className="flex flex-col sm:flex-row gap-3 mb-5">  
                        <input
                            type="text"
                            value={verbToLookup}
                            onChange={(e) => setVerbToLookup(e.target.value)}
                            placeholder={`輸入${featureLanguageName}動詞`}
                            className="flex-grow p-3 hand-drawn-border bg-white text-base focus:ring-1 focus:ring-indigo-300 outline-none" 
                            disabled={anyLoading}
                        />
                        <button
                            onClick={handleFetchVerbConjugation}
                            disabled={anyLoading || !verbToLookup.trim()}
                            className="p-3 hand-drawn-button bg-indigo-200 hover:bg-indigo-300 text-indigo-800 disabled:opacity-60 disabled:cursor-not-allowed inline-flex items-center justify-center aspect-square" 
                            title="查詢動詞變化"
                        >
                            {isVerbConjLoading 
                                ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-indigo-700"></div>
                                : <MagnifyingGlassIcon className="w-5 h-5"/>
                            }
                        </button>
                    </div>
                    {isVerbConjLoading && <p className="text-sm text-indigo-600">正在查詢動詞「{verbToLookup}」的變化...</p>}
                    {verbConjugationData && (
                        <div className="mt-5 max-h-96 overflow-y-auto prose-custom text-sm p-5 bg-white border border-dashed border-indigo-200 rounded-md">  
                            {verbConjugationData.error ? ( 
                                <p className="text-red-600">查詢「{verbConjugationData.verb_infinitive_src_lang || verbToLookup}」({verbConjugationData.language_name_for_display_zh_TW})時發生錯誤：{verbConjugationData.error}</p>
                            ) : ( 
                                <>
                                    <div className="flex justify-between items-center mb-4"> 
                                        <h4 className="text-lg font-semibold" style={{color: '#4A55A2'}}>
                                            {verbConjugationData.verb_infinitive_src_lang}
                                            <span className="text-sm font-normal"> ({verbConjugationData.language_name_for_display_zh_TW})</span>
                                        </h4>
                                        <div className="space-x-2.5"> 
                                            <button onClick={() => setAllVerbDetailsOpenState(true)} className="text-xs hand-drawn-button px-2.5 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700">全部展開</button> 
                                            <button onClick={() => setAllVerbDetailsOpenState(false)} className="text-xs hand-drawn-button px-2.5 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700">全部收合</button> 
                                        </div>
                                    </div>
                                    <p className="mb-1"><strong>規則性：</strong>{verbConjugationData.regularity_zh_TW}</p> 
                                    {verbConjugationData.verb_type_zh_TW && <p className="mt-0.5 mb-2"><strong>類型：</strong>{verbConjugationData.verb_type_zh_TW}</p>} 

                                    {verbConjugationData.conjugations?.map((mood, moodIndex) => (
                                        <details 
                                            key={`mood-${moodIndex}`} 
                                            className="mb-4" 
                                            open={verbDetailsOpenState[`mood-${moodIndex}`]} 
                                        >
                                            <summary 
                                                className={`text-md font-semibold verb-mood-summary`}
                                                onClick={(e) => { 
                                                    e.preventDefault(); 
                                                    toggleVerbDetailOpenState(`mood-${moodIndex}`); 
                                                }}
                                            > 
                                                <span>
                                                    {mood.group_name_zh_TW}
                                                    {mood.group_name_src_lang && ` (${mood.group_name_src_lang})`}
                                                </span>
                                                {verbDetailsOpenState[`mood-${moodIndex}`] 
                                                    ? <ChevronDownIcon className="w-4 h-4 inline-block ml-1 transform rotate-0" /> 
                                                    : <ChevronRightIcon className="w-4 h-4 inline-block ml-1 transform" />
                                                }
                                            </summary>
                                            <div className="pl-2.5 pt-1.5 pb-1.5"> 
                                                {mood.tenses_or_voices?.map((tense, tenseIndex) => (
                                                    <details 
                                                        key={`mood-${moodIndex}-tense-${tenseIndex}`} 
                                                        className="mt-2 mb-2.5"  
                                                        open={verbDetailsOpenState[`mood-${moodIndex}-tense-${tenseIndex}`]} 
                                                    >
                                                        <summary 
                                                            className={`text-base font-medium verb-tense-summary`}
                                                            onClick={(e) => { 
                                                                e.preventDefault(); 
                                                                toggleVerbDetailOpenState(`mood-${moodIndex}-tense-${tenseIndex}`); 
                                                            }}
                                                        > 
                                                            <span>
                                                                {tense.sub_group_name_zh_TW}
                                                                {tense.sub_group_name_src_lang && ` (${tense.sub_group_name_src_lang})`}
                                                            </span>
                                                            {verbDetailsOpenState[`mood-${moodIndex}-tense-${tenseIndex}`] 
                                                                ? <ChevronDownIcon /> 
                                                                : <ChevronRightIcon />
                                                            }
                                                        </summary>
                                                        <div className="pl-3.5 pt-2.5 pb-1.5"> 
                                                            <ul className="list-none space-y-2.5 text-xs verb-forms-list"> 
                                                                {tense.forms?.map((form, formIndex) => (
                                                                    <li key={formIndex} className="flex"> 
                                                                        <span className="font-semibold w-2/5 pr-2.5 text-right text-indigo-700">{form.person_descriptor_src_lang}:</span> 
                                                                        <span className="w-3/5 text-left">{form.conjugated_form_src_lang}</span> 
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                            {tense.example_sentence_src_lang && (
                                                                <div className="verb-example-sentence"> 
                                                                    <p><strong>例句 ({verbConjugationData.language_name_for_display_zh_TW}):</strong> {tense.example_sentence_src_lang}</p>
                                                                    {tense.example_sentence_translation_zh_TW && <p className="mt-1.5"><strong>翻譯 (繁中):</strong> {tense.example_sentence_translation_zh_TW}</p>} 
                                                                </div>
                                                            )}
                                                        </div>
                                                    </details>
                                                ))}
                                            </div>
                                        </details>
                                    ))}
                                    {verbConjugationData.notes_zh_TW && (
                                        <div className="mt-4 pt-4 border-t border-dashed border-indigo-200"> 
                                            <p className="text-sm font-semibold" style={{color: '#4A55A2'}}>備註：</p>
                                            <p className="text-xs mt-1.5">{verbConjugationData.notes_zh_TW}</p> 
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </>
            )}
          </section>


          <section className="p-7 hand-drawn-border bg-sky-50"> 
            <h3 className="text-2xl font-bold mb-6 pb-2.5 section-title-gaegu" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>我的收藏 {manualSelectedLanguage ? `(${getLanguageName(manualSelectedLanguage)})` : '(所有語言)'}</h3> 
            <div className="space-y-6 max-h-60 overflow-y-auto pr-2.5"> 
              {filteredBookmarks.length > 0 ? (
                filteredBookmarks.map((b) => (
                  <div key={b.id} className="p-5 hand-drawn-border bg-white group relative"> 
                    <button 
                        onClick={() => loadBookmarkedArticle(b.url, b.language)} 
                        className="text-left w-full"
                        title={`載入: ${b.title || b.url}`}
                    >
                        <strong className="block text-xl text-sky-700 truncate mb-2">{b.title || '未命名收藏'}</strong> 
                        <span className="text-xs text-stone-500 block truncate">{b.url}</span>
                        <span className="text-xs text-sky-600 block mt-1">({getLanguageName(b.language || b.detectedLanguage)})</span> 
                    </button>
                    <button 
                        onClick={() => removeBookmark(b.id)}
                        disabled={anyLoading}
                        className="absolute top-2.5 right-2.5 text-red-500 hover:text-red-700 opacity-50 group-hover:opacity-100 transition-opacity p-1.5 hand-drawn-button bg-red-100 hover:bg-red-200 border-red-300 disabled:opacity-50 disabled:cursor-not-allowed" 
                        aria-label="移除收藏"
                    >
                        <TrashIcon className="w-4 h-4" />
                    </button>
                  </div>
                ))
              ) : ( 
                <p className="text-stone-500 pt-3">{manualSelectedLanguage ? `沒有 ${getLanguageName(manualSelectedLanguage)} 的收藏。` : '還沒有收藏的文章喔。'}</p> 
              )}
            </div>
          </section>

          <section className="p-7 hand-drawn-border bg-purple-50"> 
            <div className="flex justify-between items-center mb-6"> 
                <h3 className="text-2xl font-bold pb-2.5 section-title-gaegu" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>我的生字簿 {manualSelectedLanguage ? `(${getLanguageName(manualSelectedLanguage)})` : '(所有語言)'}</h3> 
                {filteredVocabulary.length > 0 && (
                    <button
                        onClick={exportVocabularyToCSV}
                        disabled={anyLoading}
                        className="hand-drawn-button bg-purple-200 hover:bg-purple-300 text-purple-800 text-sm px-3.5 py-2 inline-flex items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed" 
                        title="匯出單字本 (CSV)"
                    >
                        <ArrowDownTrayIcon className="w-4 h-4" /> 匯出
                    </button>
                )}
            </div>
            {isVocabLoading && selectedText && <p className="text-sm text-purple-600">正在為「{selectedText}」查詢生字資訊...</p>}
            <div className="space-y-6 max-h-80 overflow-y-auto pr-2.5"> 
            {filteredVocabulary.length > 0 ? (
              filteredVocabulary.map((v) => (
                <div key={v.id} className="p-5 hand-drawn-border bg-white group relative text-stone-700"> 
                  <div className="flex justify-between items-start mb-3"> 
                    <strong className="text-2xl text-purple-700 break-all">{v.word} <span className="text-base text-purple-500">({getLanguageName(v.language)})</span></strong>
                    <button 
                      onClick={() => removeVocabEntry(v.id)}
                      disabled={anyLoading}
                      className="text-red-500 hover:text-red-700 opacity-50 group-hover:opacity-100 transition-opacity p-1.5 hand-drawn-button bg-red-100 hover:bg-red-200 border-red-300 disabled:opacity-50 disabled:cursor-not-allowed" 
                      aria-label="移除生字"
                    >
                      <TrashIcon className="w-4 h-4" />
                    </button>
                  </div>
                  {v.translation_zh_TW && <p className="mb-2"><span className="font-semibold text-stone-500">翻譯 (繁中):</span> {v.translation_zh_TW}</p>} 
                  {v.definitions && Array.isArray(v.definitions) && v.definitions.length > 0 && (
                    <div className="mb-2"> 
                      <p className="font-semibold text-stone-500 mb-1.5">定義/意思 ({getLanguageName(v.language)}):</p> {/* Adjusted mb */}
                      <ul className="list-disc list-inside pl-3.5 text-sm space-y-1.5"> 
                        {v.definitions.map((def, i) => <li key={`${v.id}-def-${i}`}>{def}</li>)}
                      </ul>
                    </div>
                  )}
                  {v.example_sentence && <p className="text-sm mb-1.5"><span className="font-semibold text-stone-500">例句 ({getLanguageName(v.language)}):</span> <em className="italic">"{v.example_sentence}"</em></p>} 
                  {v.articleUrl && v.articleUrl !== 'general' && <p className="text-xs text-stone-400 mt-3 truncate" title={`來源文章: ${v.articleUrl}`}>來源: {v.articleUrl.length > 30 ? v.articleUrl.substring(0,27) + '...' : v.articleUrl}</p>} 
                </div>
              ))
            ) : ( 
              <p className="text-stone-500 pt-3">{manualSelectedLanguage ? `沒有 ${getLanguageName(manualSelectedLanguage)} 的生字。` : '生字簿是空的，快去選字加入吧！'}</p> 
            )}
            </div>
          </section>
        </aside>
      </div>

      {anyLoading && (
        <div className="fixed inset-0 bg-black/50 flex justify-center items-center z-50 backdrop-blur-sm">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-400"></div>
        </div>
      )}
      
      {showModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
          <div className="p-8 hand-drawn-border bg-amber-100 max-w-md w-full">
            <h4 className="text-2xl font-bold mb-6 font-gaegu" style={{color: '#8C6D46'}}>通知</h4> 
            <p className="text-lg text-stone-700 mb-8 whitespace-pre-wrap">{modalMessage}</p> 
            <button
              onClick={() => {setShowModal(false); setModalMessage(''); if(error && modalMessage.toLowerCase().includes("失敗")) setError('');}} 
              className="w-full px-5 py-4 hand-drawn-button bg-orange-300 hover:bg-orange-400 text-orange-800 font-semibold text-lg" 
            >
              我知道了
            </button>
          </div>
        </div>
      )}
      {showTranslationModal && translationResult && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
          <div className="p-8 hand-drawn-border bg-blue-100 max-w-lg w-full prose-custom">
            <h4 className="text-2xl font-bold mb-6 font-gaegu" style={{color: '#3B82F6'}}>翻譯結果</h4> 
            <div className="mb-6"> 
                <p className="font-semibold text-stone-600">原文 ({getLanguageName(translationResult.source_language_code_detected || featureLanguage)}):</p>
                <p className="p-3.5 bg-white border border-dashed border-blue-300 rounded-md text-stone-700 max-h-32 overflow-y-auto mt-2">{translationResult.original_text}</p> 
            </div>
            <div className="mb-8"> 
                <p className="font-semibold text-stone-600">翻譯 (繁體中文):</p>
                <p className="p-3.5 bg-white border border-dashed border-blue-300 rounded-md text-blue-700 font-medium max-h-32 overflow-y-auto mt-2">{translationResult.translated_text_zh_TW}</p> 
            </div>
            <button
              onClick={() => {setShowTranslationModal(false); setTranslationResult(null);}} 
              className="w-full px-5 py-4 hand-drawn-button bg-blue-300 hover:bg-blue-400 text-blue-800 font-semibold text-lg" 
            >
              關閉
            </button>
          </div>
        </div>
      )}
      {error && !showModal && !showTranslationModal && ( 
         <div className="fixed bottom-5 right-5 p-5 hand-drawn-border bg-red-200 text-red-800 max-w-md z-40"> 
           <p className="font-bold text-lg font-gaegu mb-1">哎呀，出錯了：</p> 
           <p className="text-md whitespace-pre-wrap mt-1.5">{error}</p> 
           <button onClick={() => setError('')} className="mt-3 text-sm underline text-red-700">關閉</button> 
       </div>
      )}
      <footer className="mt-20 text-center text-sm text-stone-500"> 
        <p className="font-gaegu mb-1">語言學習小幫手 &copy; 2024-2025</p> 
        <p className="mt-2">網頁內容提取與 AI 功能依賴外部服務，可能並非所有情況都能成功處理喔！</p> 
      </footer>
    </div>
  );
}

export default App;

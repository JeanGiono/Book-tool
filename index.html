<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIFT TOOL v7.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #f8fafc; /* slate-50 */
            --secondary-bg: #ffffff;
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-color-dark: #0284c7; /* sky-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --today-bg: #f0f9ff; /* sky-50 */
            --selected-bg: #93c5fd; /* blue-300 */
            --selected-border: #3b82f6; /* blue-500 */
            --danger-color: #ef4444; /* red-500 */
            --danger-color-dark: #dc2626; /* red-600 */
        }
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }
        .calendar-day {
            min-height: 120px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .calendar-day.drag-over {
            transform: scale(1.03);
            box-shadow: 0 0 0 3px var(--accent-color);
            z-index: 20;
        }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .day-number {
            font-weight: 500; color: var(--text-secondary); font-size: 0.875rem;
        }
        .day-number.weekend { color: var(--danger-color); font-weight: 700; }
        .day-number.today {
            background-color: var(--accent-color); color: white; border-radius: 9999px;
            width: 1.75rem; height: 1.75rem;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .day-content {
            flex-grow: 1; display: flex; flex-direction: column; gap: 4px; overflow: hidden;
        }
        .event-pill {
            padding: 3px 8px; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 6px;
        }
        .pill-primary { background-color: #e0f2fe; color: #075985; }
        .pill-secondary { background-color: #eef2ff; color: #3730a3; }
        .pill-sentry { background-color: #fef2f2; color: #991b1b; }
        .pill-holiday { background-color: #f0fdf4; color: #15803d; }
        .pill-weekend { background-color: #fffbeb; color: #b45309; }

        .multi-selected-day {
             border-color: var(--selected-border) !important;
             background-color: #eff6ff; /* blue-50 */
             box-shadow: 0 0 0 2px var(--selected-border);
        }
        .filtered-out {
            background-color: #f1f5f9 !important; opacity: 0.7;
        }
        .filtered-out .day-content { visibility: hidden; }
        .modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(15, 23, 42, 0.5);
            align-items: center; justify-content: center; transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: var(--primary-bg); margin: auto; padding: 24px;
            border: 1px solid var(--border-color); width: 90%;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            max-height: 90vh; overflow-y: auto;
        }
        #managementModal .modal-content { max-width: 700px; }
        #confirmModal .modal-content { max-width: 420px; }
        #assignmentModal .modal-content { max-width: 380px; }
        .close-button { color: #94a3b8; transition: color 0.2s; }
        .close-button:hover { color: var(--text-primary); }

        .custom-alert {
            display: none; position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); padding: 16px; border-radius: 0.5rem;
            z-index: 1050; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 320px; text-align: center; font-weight: 500;
        }
        .custom-alert.error { background-color: #fecaca; color: #991b1b; }
        .custom-alert.success { background-color: #dcfce7; color: #166534; }
        .custom-alert.loading { background-color: #fef9c3; color: #854d0e; }
        .custom-alert.info { background-color: #cffafe; color: #0891b2; }

        .tab-button {
            padding: 0.75rem 0.25rem; margin-right: 1.5rem; font-weight: 500;
            border-bottom: 3px solid transparent; color: var(--text-secondary);
            transition: all 0.3s ease; font-size: 1rem;
        }
        .tab-button:hover { border-bottom-color: var(--accent-color-dark); color: var(--text-primary); }
        .tab-button.active-tab {
            border-bottom-color: var(--accent-color); color: var(--accent-color); font-weight: 700;
        }
        .btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500;
            transition: all 0.2s ease-in-out; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent;
        }
        .btn-primary { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .btn-primary:hover { background-color: var(--accent-color-dark); border-color: var(--accent-color-dark); }
        .btn-secondary { background-color: var(--secondary-bg); color: var(--text-secondary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--primary-bg); border-color: #cbd5e1; }
        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color-dark); border-color: var(--danger-color-dark); }
        .btn-ghost { background-color: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background-color: var(--primary-bg); color: var(--text-primary); }
        .form-input {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color);
            background-color: var(--secondary-bg); border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        .draggable-staff-item {
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .draggable-staff-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* --- 手機版響應式調整 (Responsive Adjustments for Mobile) --- */
        @media (max-width: 640px) {
            .event-pill {
                font-size: 0.6rem;
                padding: 2px 4px;
                gap: 3px;
            }
            .calendar-day {
                padding: 0.35rem;
                min-height: 100px;
            }
            .day-content {
                 gap: 2px;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="customAlert" class="custom-alert">
        <span id="customAlertMessage"></span>
    </div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
             <div>
                <h1 id="mainTitle" class="text-3xl font-bold text-slate-900">SHIFT TOOL</h1>
                <p class="text-slate-500 mt-1">您的智慧化排班管理中心</p>
             </div>
             <button id="openManagementModalButton" type="button" class="btn btn-primary">
                <i class="fas fa-cog"></i><span>管理設定</span>
             </button>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <section class="bg-white p-4 sm:p-6 shadow-lg rounded-xl lg:col-span-3" aria-labelledby="calendar-section-title">
                <h2 id="calendar-section-title" class="sr-only">班表日曆與控制區域</h2>
                
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                     <div class="flex items-center gap-4">
                        <button type="button" onclick="Calendar.changeMonth(-1)" class="btn btn-secondary px-3" aria-label="上個月"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="monthYearDisplay" class="text-2xl font-bold text-slate-800 text-center w-48" aria-live="polite"></h2>
                        <button type="button" onclick="Calendar.changeMonth(1)" class="btn btn-secondary px-3" aria-label="下個月"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <nav aria-label="Tabs">
                        <div class="flex space-x-2 sm:space-x-4 border-b border-gray-200">
                            <button id="primaryScheduleTabButton" type="button" class="tab-button active-tab" role="tab" aria-selected="true">主要班表</button>
                            <button id="secondaryScheduleTabButton" type="button" class="tab-button" role="tab" aria-selected="false">週末班表</button>
                        </div>
                    </nav>
                </div>

                <div id="secondaryScheduleControlsAboveCalendar" class="mb-4 hidden">
                </div>
                
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm py-2 text-slate-500">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </section>
            
            <aside id="primaryScheduleControls" class="space-y-6">
                <div class="bg-white p-4 shadow-lg rounded-xl">
                    <h3 class="font-semibold text-slate-800 mb-3">排班人員 (可拖曳)</h3>
                    <div id="draggableStaffList" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-sm text-slate-500 p-2">沒有可用的主要班表人員。</p>
                    </div>
                     <p class="text-xs text-slate-400 mt-2 text-center">將人員拖曳至日期上即可排班</p>
                </div>

                <div class="bg-white p-4 shadow-lg rounded-xl">
                    <h3 class="font-semibold text-slate-800 mb-3">批次操作</h3>
                    <div id="batchActions" class="space-y-2">
                         <div class="text-center text-sm text-slate-500 p-2 border-dashed border-2 border-slate-200 rounded-lg">
                            <p id="selectionCount">尚未選取任何日期</p>
                            <p class="text-xs text-slate-400 mt-1">點擊日期可選取，按住 Ctrl/Cmd 可複選</p>
                        </div>
                        <button id="batchAssignButton" class="btn btn-primary w-full" disabled><i class="fa-solid fa-people-arrows"></i> 指派給選定日期</button>
                        <button id="batchClearButton" class="btn btn-danger w-full" disabled><i class="fa-solid fa-eraser"></i> 清除選定日期</button>
                    </div>
                </div>

                <div class="bg-white p-4 shadow-lg rounded-xl">
                    <div class="flex-grow">
                        <label for="staffFilterSelect" class="block text-sm font-medium text-slate-700 mb-1">篩選與匯出</label>
                        <select id="staffFilterSelect" class="form-input"></select>
                    </div>
                     <div class="flex-shrink-0 mt-4">
                         <button id="exportPrimaryScheduleButton" type="button" class="btn bg-green-600 text-white hover:bg-green-700 w-full sm:w-auto">
                             <i class="fas fa-download"></i><span id="exportButtonText">匯出主要班表 (.ics)</span>
                         </button>
                    </div>
                </div>
            </aside>
        </div>
         <footer class="text-center mt-8 text-slate-500 text-sm">
            Copyright © Jean Giono
        </footer>
    </main>

    <!-- Modals -->
    <div id="managementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="managementModalTitle">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="managementModalTitle" class="text-2xl font-bold text-slate-800">管理設定</h3>
                <button id="closeManagementModalButton" class="btn btn-ghost" aria-label="關閉"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-8">
                <section aria-labelledby="import-section-title">
                    <h4 id="import-section-title" class="text-lg font-semibold text-slate-700 mb-4 pb-2 border-b-2 border-slate-200">人員與班表匯入</h4>
                    <div class="space-y-4">
                        <form onsubmit="event.preventDefault(); StaffManager.processStaffNames();">
                            <div>
                                <label for="staffNameInput" class="block text-sm font-medium text-slate-700 mb-1">手動新增/管理主要班表人員 (每行一人)</label>
                                <textarea id="staffNameInput" rows="2" class="form-input" placeholder="例如：王小明"></textarea>
                                <button type="submit" class="btn btn-primary w-full mt-2"><i class="fas fa-users"></i>處理主要班表名單</button>
                            </div>
                        </form>
                        <form onsubmit="event.preventDefault(); ScheduleParser.triggerImportScheduleFromPastedText();">
                            <div>
                                <label for="fullSchedulePasteArea" class="block text-sm font-medium text-slate-700 mb-1">貼上主要班表文字</label>
                                <textarea id="fullSchedulePasteArea" rows="3" class="form-input" placeholder="可貼上包含 'XXX年Y月' 及 '姓名' 與日期標頭的純文字班表。"></textarea>
                                <button type="submit" class="btn bg-orange-500 text-white hover:bg-orange-600 w-full mt-2"><i class="fas fa-paste"></i>匯入貼上之文字</button>
                            </div>
                        </form>
                        <div>
                           <label for="holidayFileImport" class="block text-sm font-medium text-slate-700 mb-1">匯入假期檔案 (.ics)</label>
                           <input type="file" id="holidayFileImport" accept=".ics" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 cursor-pointer">
                           <button type="button" onclick="HolidayImporter.triggerHolidayImport()" class="btn bg-cyan-600 text-white hover:bg-cyan-700 w-full mt-2"><i class="fas fa-calendar-check"></i>匯入假期</button>
                        </div>
                    </div>
                </section>

                <section aria-labelledby="automation-section-title">
                    <h4 id="automation-section-title" class="text-lg font-semibold text-slate-700 mb-4 pb-2 border-b-2 border-slate-200">自動化與特殊功能</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <section aria-labelledby="automation-title-modal">
                            <h5 id="automation-title-modal" class="font-semibold mb-2 text-slate-600">主要班表自動化</h5>
                            <div class="space-y-2">
                                <button type="button" onclick="AutoScheduler.triggerAutoSchedule()" class="btn bg-purple-600 text-white hover:bg-purple-700 w-full"><i class="fas fa-magic"></i>自動產生班表</button>
                                <button type="button" onclick="AutoScheduler.carryOverToNextMonth()" class="btn bg-teal-600 text-white hover:bg-teal-700 w-full"><i class="fas fa-arrow-right"></i>預排次月班表</button>
                            </div>
                        </section>
                        <section aria-labelledby="sentry-schedule-title-modal">
                            <h5 id="sentry-schedule-title-modal" class="font-semibold mb-2 text-slate-600">查哨班表設定</h5>
                            <form id="sentryScheduleForm" onsubmit="event.preventDefault(); SentryScheduler.updateInitialConditionFromForm();" class="space-y-2">
                                <div>
                                    <label for="sentryStartDate" class="sr-only">起始日期:</label>
                                    <input type="date" id="sentryStartDate" class="form-input">
                                </div>
                                <div>
                                    <label for="sentryStartTime" class="sr-only">起始時間:</label>
                                     <select id="sentryStartTime" class="form-input"></select>
                                </div>
                                <button type="submit" class="btn bg-rose-500 text-white hover:bg-rose-600 w-full"><i class="fas fa-sync-alt"></i>更新查哨起始</button>
                            </form>
                        </section>
                    </div>
                </section>

                <section aria-labelledby="data-management-section-title">
                    <h4 id="data-management-section-title" class="text-lg font-semibold text-slate-700 mb-4 pb-2 border-b-2 border-slate-200">資料管理</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                             <h5 class="font-semibold mb-2 text-slate-600">儲存與清除</h5>
                            <button id="savePrimaryScheduleButton" type="button" class="btn btn-primary w-full"><i class="fas fa-save"></i>儲存所有變更</button>
                            <button id="clearPrimaryScheduleButton" type="button" class="btn btn-danger w-full"><i class="fas fa-trash"></i>清除本月主要班表</button>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2 text-slate-600">主要班表目前人員:</h5>
                            <div id="staffList" class="max-h-40 overflow-y-auto p-2 border border-slate-200 rounded-md bg-white">
                                <p class="text-sm text-slate-500">尚未新增任何主要班表人員。</p>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">注意：所有資料將儲存在您的瀏覽器中。</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="assignmentModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="assignmentModalTitle">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="assignmentModalTitle" class="text-lg font-semibold">指派給已選日期</h3>
                <button class="btn btn-ghost" onclick="UI.closeAssignmentModal()" aria-label="關閉"><i class="fas fa-times text-xl"></i></button>
            </div>
            <p id="noStaffMessage" class="text-slate-600 hidden p-4 text-center bg-yellow-50 border border-yellow-200 rounded-lg">請先在「管理設定」中新增主要班表人員。</p>
            <div id="modalStaffList" class="space-y-1 max-h-60 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="autoScheduleConfirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="autoScheduleConfirmModalTitle">
        <div class="modal-content max-h-[80vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h3 id="autoScheduleConfirmModalTitle" class="text-lg font-semibold text-slate-800">確認自動排班</h3>
                <button class="btn btn-ghost" onclick="UI.closeAutoScheduleConfirmModal()" aria-label="關閉"><i class="fas fa-times text-xl"></i></button>
            </div>
            <p id="autoScheduleConfirmMessage" class="text-slate-600 mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"></p>
            <form id="autoScheduleForm" onsubmit="event.preventDefault(); AutoScheduler.proceedWithAutoSchedule(); UI.closeAutoScheduleConfirmModal();" class="space-y-4">
                <div>
                    <label for="startMonThuSelect" class="block text-sm font-medium text-slate-700 mb-1">週一至週四起始人員:</label>
                    <select id="startMonThuSelect" class="form-input"></select>
                </div>
                <div>
                    <label for="startFriSelect" class="block text-sm font-medium text-slate-700 mb-1">週五起始人員:</label>
                    <select id="startFriSelect" class="form-input"></select>
                </div>
                <div>
                    <label for="startWeekendSelect" class="block text-sm font-medium text-slate-700 mb-1">週末起始人員:</label>
                    <select id="startWeekendSelect" class="form-input"></select>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" onclick="UI.closeAutoScheduleConfirmModal()" class="btn btn-secondary">取消</button>
                    <button id="confirmAutoScheduleButton" type="submit" class="btn btn-primary">確定執行</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
        <div class="modal-content text-center">
            <div class="mx-auto bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 id="confirmModalTitle" class="text-xl font-bold text-slate-800"><span></span></h3>
            <p id="confirmModalMessage" class="text-slate-600 my-4"></p>
            <div class="flex justify-center space-x-3">
                <button id="cancelConfirmButton" type="button" class="btn btn-secondary w-24">取消</button>
                <button id="acceptConfirmButton" type="button" class="btn btn-danger w-24">確認</button>
            </div>
        </div>
    </div>
    
    <script>
    // --- STATE & CONFIG ---
    let AppState = {
        currentYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth(),
        activeView: 'primary',
        defaultStaffNames: ["劉學翰", "廖志龍", "袁國維", "張靖興", "曾名賢"],
        staffNames: [],
        shifts: {},
        staffColors: {},
        selectedStaffForFilter: "ALL",
        holidays: {},
        multiSelectedDates: new Set(),
        defaultPrimaryScheduleStarters: {
            "2025-06": { monThu: "劉學翰", fri: "曾名賢", weekend: "曾名賢" }
        },
        secondarySchedule: {
            staff: ["劉學翰", "廖志龍", "張靖興"],
            groupDefinitions: [
                { name: "A", members: ["劉學翰", "廖志龍"], color: { background: '#FFEBEE', text: '#C62828' } },
                { name: "B", members: ["張靖興", "劉學翰"], color: { background: '#E3F2FD', text: '#1565C0' } },
                { name: "C", members: ["廖志龍", "張靖興"], color: { background: '#E8F5E9', text: '#2E7D32' } }
            ],
            anchor: { date: '2025-05-31', groupName: 'B' },
            shifts: {},
            isStaffInfoVisible: false
        },
        sentrySchedule: {
            shifts: {},
            initialCondition: { date: "2025-06-01", time: "02:00-04:00" },
            config: {
                resetTime: "06:00-08:00",
                restartTime: "08:00-10:00",
                shiftDurationHours: 2,
                restDayLabel: "休"
            },
            timeSlots: [
                "00:00-02:00", "02:00-04:00", "04:00-06:00", "06:00-08:00", 
                "08:00-10:00", "10:00-12:00", "12:00-14:00", "14:00-16:00",
                "16:00-18:00", "18:00-20:00", "20:00-22:00", "22:00-00:00"
            ]
        }
    };

    const PREDEFINED_COLORS = [
        { background: '#e0f2fe', text: '#075985' }, { background: '#eef2ff', text: '#3730a3' },
        { background: '#fefce8', text: '#854d0e' }, { background: '#f0fdf4', text: '#15803d' },
        { background: '#fdf2f8', text: '#9d174d' }, { background: '#fae8ff', text: '#701a75' },
        { background: '#fef2f2', text: '#991b1b' }, { background: '#fff7ed', text: '#9a3412' }
    ];

    const UIElements = {};

    // --- UTILS ---
    const Utils = {
        showCustomAlert: (message, type = 'error', duration = 3500) => {
            if (!UIElements.customAlertBox || !UIElements.customAlertMessageBox) return;
            UIElements.customAlertMessageBox.textContent = message;
            UIElements.customAlertBox.className = 'custom-alert';
            UIElements.customAlertBox.classList.add(type);
            UIElements.customAlertBox.style.display = 'block';
            if (duration > 0) {
                setTimeout(() => { if(UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none'; }, duration);
            }
        },
        hideCustomAlert: () => {
            if (UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none';
        },
        getLocalStorageKey: (dataType) => {
            const version = "v7.2_interactive"; 
            if (['holidays_all', 'secondary_shifts', 'sentry_shifts', 'sentry_initial_condition'].includes(dataType)){
                return `shiftSchedule_${version}_${dataType}`;
            }
            const year = AppState.currentYear;
            const month = AppState.currentMonth;
            return `shiftSchedule_${version}_${dataType}_${year}_${String(month + 1).padStart(2, '0')}`;
        },
        formatDateToKey: (dateObj) => {
            if (!dateObj) return null;
            const year = dateObj.getUTCFullYear();
            const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    };
    
    // --- DATA STORAGE ---
    const DataStorage = {
        loadData: () => {
            try {
                const staffData = localStorage.getItem(Utils.getLocalStorageKey('staff'));
                AppState.staffNames = staffData ? JSON.parse(staffData) : [...AppState.defaultStaffNames];
                if (AppState.staffNames.length === 0 && AppState.defaultStaffNames.length > 0) AppState.staffNames = [...AppState.defaultStaffNames];
                const shiftsData = localStorage.getItem(Utils.getLocalStorageKey('shifts'));
                AppState.shifts = shiftsData ? JSON.parse(shiftsData) : {};
                const staffColorsData = localStorage.getItem(Utils.getLocalStorageKey('staffColors'));
                AppState.staffColors = staffColorsData ? JSON.parse(staffColorsData) : {};
                StaffManager.assignColorsToStaff();
                const holidaysData = localStorage.getItem(Utils.getLocalStorageKey('holidays_all'));
                AppState.holidays = holidaysData ? JSON.parse(holidaysData) : {};
                const secondaryShiftsData = localStorage.getItem(Utils.getLocalStorageKey('secondary_shifts'));
                AppState.secondarySchedule.shifts = secondaryShiftsData ? JSON.parse(secondaryShiftsData) : {};
                const sentryShiftsData = localStorage.getItem(Utils.getLocalStorageKey('sentry_shifts'));
                AppState.sentrySchedule.shifts = sentryShiftsData ? JSON.parse(sentryShiftsData) : {};
                const sentryInitialData = localStorage.getItem(Utils.getLocalStorageKey('sentry_initial_condition'));
                if(sentryInitialData) AppState.sentrySchedule.initialCondition = JSON.parse(sentryInitialData);
            } catch (e) {
                console.error("從 localStorage 讀取資料時發生錯誤:", e);
                Utils.showCustomAlert("讀取儲存資料時發生錯誤。", "error");
            }
        },
        saveData: () => {
            try {
                localStorage.setItem(Utils.getLocalStorageKey('staff'), JSON.stringify(AppState.staffNames));
                localStorage.setItem(Utils.getLocalStorageKey('shifts'), JSON.stringify(AppState.shifts));
                localStorage.setItem(Utils.getLocalStorageKey('staffColors'), JSON.stringify(AppState.staffColors));
                localStorage.setItem(Utils.getLocalStorageKey('holidays_all'), JSON.stringify(AppState.holidays));
                localStorage.setItem(Utils.getLocalStorageKey('secondary_shifts'), JSON.stringify(AppState.secondarySchedule.shifts));
                localStorage.setItem(Utils.getLocalStorageKey('sentry_shifts'), JSON.stringify(AppState.sentrySchedule.shifts));
                localStorage.setItem(Utils.getLocalStorageKey('sentry_initial_condition'), JSON.stringify(AppState.sentrySchedule.initialCondition));
            } catch (e) {
                console.error("儲存資料到 localStorage 時發生錯誤:", e);
                Utils.showCustomAlert("儲存資料時發生錯誤，可能是儲存空間已滿。", "error");
            }
        },
        clearCurrentMonthPrimarySchedule: () => {
            const currentMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            let shiftsClearedCount = 0;
            for (const dateKey in AppState.shifts) {
                if (dateKey.startsWith(currentMonthPrefix)) {
                    delete AppState.shifts[dateKey];
                    shiftsClearedCount++;
                }
            }
            DataStorage.saveData();
            Calendar.render();
            if (shiftsClearedCount > 0) {
                 Utils.showCustomAlert(`已清除 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的主要班表資料。`, "success");
            } else {
                 Utils.showCustomAlert(`${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的主要班表無資料可清除。`, "info");
            }
        }
    };

    // --- IMPORTERS ---
    const HolidayImporter = {
        parseICS: (icsContent) => {
            const lines = icsContent.split(/\r\n|\n|\r/);
            let inEvent = false;
            let currentEvent = { DTSTART_val: null, DTEND_val: null, SUMMARY_val: null };
            let newHolidays = {};
            const parseDateFromICSLine = (line) => {
                if (!line) return null;
                const dateStrPart = line.substring(line.indexOf(':') + 1);
                const actualDateStr = dateStrPart.includes('VALUE=DATE:') ? dateStrPart.substring('VALUE=DATE:'.length) : dateStrPart;
                if (actualDateStr.length < 8) return null;
                const year = parseInt(actualDateStr.substring(0, 4));
                const month = parseInt(actualDateStr.substring(4, 6)) - 1;
                const day = parseInt(actualDateStr.substring(6, 8));
                if (isNaN(year) || isNaN(month) || isNaN(day) || month < 0 || month > 11 || day < 1 || day > 31) return null;
                return new Date(Date.UTC(year, month, day));
            };

            for (const line of lines) {
                if (line.toUpperCase().startsWith('BEGIN:VEVENT')) {
                    inEvent = true;
                    currentEvent = { DTSTART_val: null, DTEND_val: null, SUMMARY_val: null };
                } else if (line.toUpperCase().startsWith('END:VEVENT')) {
                    if (inEvent && currentEvent.DTSTART_val && currentEvent.SUMMARY_val) {
                        let startDate = currentEvent.DTSTART_val;
                        let endDate = currentEvent.DTEND_val;
                        if (!endDate || endDate.getTime() <= startDate.getTime()) {
                            const formattedDate = Utils.formatDateToKey(startDate);
                            if (formattedDate) newHolidays[formattedDate] = currentEvent.SUMMARY_val;
                        } else {
                            let currentDate = new Date(startDate.getTime());
                            while (currentDate.getTime() < endDate.getTime()) {
                                const formattedDate = Utils.formatDateToKey(currentDate);
                                if (formattedDate) newHolidays[formattedDate] = currentEvent.SUMMARY_val;
                                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                            }
                        }
                    }
                    inEvent = false;
                } else if (inEvent) {
                    if (line.toUpperCase().startsWith('DTSTART')) currentEvent.DTSTART_val = parseDateFromICSLine(line);
                    else if (line.toUpperCase().startsWith('DTEND')) currentEvent.DTEND_val = parseDateFromICSLine(line);
                    else if (line.toUpperCase().startsWith('SUMMARY')) currentEvent.SUMMARY_val = line.substring(line.indexOf(':') + 1).trim();
                }
            }
            return newHolidays;
        },
        triggerHolidayImport: () => {
            const fileInput = document.getElementById('holidayFileImport');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                Utils.showCustomAlert("請先選擇一個 .ics 假期檔案。", "info");
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedHolidays = HolidayImporter.parseICS(e.target.result);
                    if (Object.keys(importedHolidays).length > 0) {
                        AppState.holidays = { ...AppState.holidays, ...importedHolidays };
                        DataStorage.saveData();
                        Calendar.render();
                        Utils.showCustomAlert(`成功匯入 ${Object.keys(importedHolidays).length} 個假期。`, "success");
                    } else {
                        Utils.showCustomAlert("未在檔案中找到有效的假期事件。", "info");
                    }
                } catch (err) {
                    Utils.showCustomAlert("解析假期檔案時發生錯誤。", "error");
                } finally {
                    fileInput.value = "";
                }
            };
            reader.onerror = () => { Utils.showCustomAlert("讀取假期檔案時發生錯誤。", "error"); fileInput.value = ""; };
            reader.readAsText(file);
        }
    };
    
    // --- SCHEDULERS ---
    const SecondaryScheduler = {
        getGroupForWeekend: (saturdayDateStr) => {
            const { groupDefinitions, anchor } = AppState.secondarySchedule;
            const numGroups = groupDefinitions.length;
            if (numGroups === 0) return null;
            const anchorGroupIndex = groupDefinitions.findIndex(g => g.name === anchor.groupName);
            if (anchorGroupIndex === -1) return groupDefinitions[0];
            const anchorDate = new Date(anchor.date + 'T00:00:00Z');
            const targetSaturday = new Date(saturdayDateStr + 'T00:00:00Z');
            const diffInWeeks = Math.round((targetSaturday.getTime() - anchorDate.getTime()) / (1000 * 60 * 60 * 24 * 7));
            const finalGroupIndex = (anchorGroupIndex + diffInWeeks % numGroups + numGroups) % numGroups;
            return groupDefinitions[finalGroupIndex];
        },
        ensureScheduleForCurrentMonth: () => {
            const year = AppState.currentYear;
            const month_0_indexed = AppState.currentMonth;
            const daysInMonth = new Date(year, month_0_indexed + 1, 0).getDate();
            const currentMonthKey = `${year}-${String(month_0_indexed + 1).padStart(2, '0')}`;
            let needsSave = false;
            
            Object.keys(AppState.secondarySchedule.shifts)
                  .filter(key => key.startsWith(currentMonthKey))
                  .forEach(key => delete AppState.secondarySchedule.shifts[key]);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = new Date(year, month_0_indexed, day).getDay();
                const utcDate = new Date(Date.UTC(year, month_0_indexed, day));
                const dateStr = Utils.formatDateToKey(utcDate);
                
                if (AppState.secondarySchedule.shifts[dateStr]) continue;

                if (dayOfWeek === 6) { // Saturday
                    const weekendGroup = SecondaryScheduler.getGroupForWeekend(dateStr);
                    if (weekendGroup) {
                        AppState.secondarySchedule.shifts[dateStr] = weekendGroup.name;
                        needsSave = true;
                        if (day + 1 <= daysInMonth) {
                            const sundayUtcDate = new Date(Date.UTC(year, month_0_indexed, day + 1));
                            AppState.secondarySchedule.shifts[Utils.formatDateToKey(sundayUtcDate)] = weekendGroup.name;
                        }
                    }
                } else if (dayOfWeek === 0 && !AppState.secondarySchedule.shifts[dateStr]) { // Sunday, if not already assigned
                    const prevDayUtc = new Date(utcDate.getTime() - (24 * 60 * 60 * 1000));
                    const prevDayDateStr = Utils.formatDateToKey(prevDayUtc);
                    const weekendGroup = SecondaryScheduler.getGroupForWeekend(prevDayDateStr);
                    if (weekendGroup) {
                        AppState.secondarySchedule.shifts[dateStr] = weekendGroup.name;
                        needsSave = true;
                    }
                }
            }
            if (needsSave) { DataStorage.saveData(); }
        }
    };
    const SentryScheduler = {
        recalculateAll: () => {
            Utils.showCustomAlert("正在重算查哨班表...", "loading", 0);
            AppState.sentrySchedule.shifts = {};
            const { initialCondition, config, timeSlots } = AppState.sentrySchedule;
            if (!initialCondition.date || !initialCondition.time) {
                Utils.showCustomAlert("查哨班表缺少有效的起始條件。", "error"); return;
            }
            let currentDate = new Date(initialCondition.date + 'T00:00:00Z');
            currentDate.setUTCHours(0,0,0,0);
            let currentTimeSlot = initialCondition.time;
            const endDate = new Date(new Date().getFullYear() + 5, 11, 31);
            while (currentDate <= endDate) {
                const dateKey = Utils.formatDateToKey(currentDate);
                AppState.sentrySchedule.shifts[dateKey] = currentTimeSlot;
                if (currentTimeSlot === config.resetTime) {
                    currentDate.setUTCDate(currentDate.getUTCDate() + 2);
                    currentTimeSlot = config.restartTime;
                } else {
                    const currentIndex = timeSlots.indexOf(currentTimeSlot);
                    const nextIndex = (currentIndex + 1) % timeSlots.length;
                    currentTimeSlot = timeSlots[nextIndex];
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                }
            }
            DataStorage.saveData();
            Utils.hideCustomAlert();
            Utils.showCustomAlert("查哨班表已重算完畢。", "success");
            if (AppState.activeView === 'primary') Calendar.render();
        },
        updateInitialConditionFromForm: () => {
            const startDate = UIElements.sentryStartDate.value;
            const startTime = UIElements.sentryStartTime.value;
            if (!startDate || !startTime) {
                Utils.showCustomAlert("請選擇有效的起始日期和時間。", "info"); return;
            }
            AppState.sentrySchedule.initialCondition = { date: startDate, time: startTime };
            SentryScheduler.recalculateAll();
            UI.closeManagementModal();
        }
    };
    
    // --- STAFF MANAGEMENT ---
    const StaffManager = {
        assignColorsToStaff: () => {
            const newStaffColors = {};
            let localNextColorIndex = 0;
            AppState.staffNames.forEach(name => {
                if (AppState.staffColors && AppState.staffColors[name]) newStaffColors[name] = AppState.staffColors[name];
            });
            const usedBackgroundColors = new Set(Object.values(newStaffColors).map(color => color.background));
            AppState.staffNames.forEach(name => {
                if (!newStaffColors[name]) {
                    let assigned = false;
                    for (let i = 0; i < PREDEFINED_COLORS.length; i++) {
                        const colorCandidate = PREDEFINED_COLORS[(localNextColorIndex + i) % PREDEFINED_COLORS.length];
                        if (!usedBackgroundColors.has(colorCandidate.background)) {
                            newStaffColors[name] = colorCandidate;
                            usedBackgroundColors.add(colorCandidate.background);
                            assigned = true; break;
                        }
                    }
                    if (!assigned) newStaffColors[name] = PREDEFINED_COLORS[localNextColorIndex % PREDEFINED_COLORS.length];
                    localNextColorIndex++;
                }
            });
            AppState.staffColors = newStaffColors;
        },
        processStaffNames: () => {
            if (!UIElements.staffNameInput) return;
            const namesText = UIElements.staffNameInput.value.trim();
            if (namesText) {
                const newStaff = namesText.split('\n').map(name => name.trim()).filter(name => name);
                if (newStaff.length > 0) {
                    AppState.staffNames = Array.from(new Set([...AppState.staffNames, ...newStaff]));
                    StaffManager.assignColorsToStaff();
                    UI.updateStaffListUI();
                    UI.updateStaffFilterUI();
                    DataStorage.saveData();
                    UIElements.staffNameInput.value = '';
                    Utils.showCustomAlert("主要班表人員名單已更新。", "success");
                } else {
                    Utils.showCustomAlert("請輸入有效的主要班表人員名單。", "error");
                }
            } else {
                 Utils.showCustomAlert("主要班表人員名單輸入框為空，未做更改。", "info");
            }
        },
        removeStaffMember: (indexToRemove) => {
            const removedName = AppState.staffNames[indexToRemove];
            AppState.staffNames.splice(indexToRemove, 1);
            delete AppState.staffColors[removedName];
            const currentMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            for (const date in AppState.shifts) {
                if (date.startsWith(currentMonthPrefix) && AppState.shifts[date] === removedName) {
                     delete AppState.shifts[date];
                }
            }
            if (AppState.selectedStaffForFilter === removedName) AppState.selectedStaffForFilter = "ALL";
            UI.updateStaffListUI();
            UI.updateStaffFilterUI();
            Calendar.render();
            DataStorage.saveData();
            Utils.showCustomAlert(`${removedName} 已從主要班表移除，其在本月的相關班次已清除。`, "success");
        }
    };
    
    // --- CALENDAR RENDERING ---
    const Calendar = {
        render: () => {
            if (!UIElements.monthYearDisplay || !UIElements.calendarGrid) return;
            UIElements.calendarGrid.innerHTML = '';
            SecondaryScheduler.ensureScheduleForCurrentMonth();
            const today = new Date();
            const todayStr = Utils.formatDateToKey(new Date(today.getFullYear(), today.getMonth(), today.getDate()));
            const firstDayOfMonth = new Date(AppState.currentYear, AppState.currentMonth, 1);
            const daysInMonth = new Date(AppState.currentYear, AppState.currentMonth + 1, 0).getDate();
            const dayOfWeek = firstDayOfMonth.getDay();
            UIElements.monthYearDisplay.textContent = `${AppState.currentYear}年 ${AppState.currentMonth + 1}月`;
            for (let i = 0; i < dayOfWeek; i++) {
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-day blank bg-slate-50/50 cursor-default';
                UIElements.calendarGrid.appendChild(blankCell);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDate = new Date(AppState.currentYear, AppState.currentMonth, day);
                const currentDayOfWeek = currentDate.getDay();
                const isWeekend = currentDayOfWeek === 0 || currentDayOfWeek === 6;
                const holidayName = AppState.holidays[dateStr];
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.dataset.date = dateStr;

                if (AppState.multiSelectedDates.has(dateStr)) dayCell.classList.add('multi-selected-day');

                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                if (dateStr === todayStr) dayNumber.classList.add('today');
                if (isWeekend || holidayName) dayNumber.classList.add('weekend');
                dayHeader.appendChild(dayNumber);
                dayCell.appendChild(dayHeader);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'day-content';
                
                if (AppState.activeView === 'primary') {
                    const primaryShiftPersonName = AppState.shifts[dateStr];
                    if (primaryShiftPersonName) {
                         if (AppState.selectedStaffForFilter === "ALL" || AppState.selectedStaffForFilter === primaryShiftPersonName) {
                            const personColor = AppState.staffColors[primaryShiftPersonName] || PREDEFINED_COLORS[0];
                            const pill = document.createElement('div');
                            pill.className = 'event-pill';
                            pill.style.backgroundColor = personColor.background;
                            pill.style.color = personColor.text;
                            pill.textContent = primaryShiftPersonName.length > 2 ? primaryShiftPersonName.substring(primaryShiftPersonName.length - 2) : primaryShiftPersonName;
                            contentWrapper.appendChild(pill);
                        } else {
                            dayCell.classList.add('filtered-out');
                        }
                    } else {
                        if (AppState.selectedStaffForFilter !== "ALL") dayCell.classList.add('filtered-out');
                    }

                    const sentryShiftTime = AppState.sentrySchedule.shifts[dateStr];
                    if (sentryShiftTime && sentryShiftTime !== AppState.sentrySchedule.config.restDayLabel) {
                        const pill = document.createElement('div');
                        pill.className = 'event-pill pill-sentry';
                        const startHour = sentryShiftTime.split(':')[0];
                        pill.innerHTML = `<i class="fas fa-search-location fa-fw"></i> <span>${startHour}</span>`;
                        contentWrapper.appendChild(pill);
                    }
                    
                    if(holidayName){
                        const pill = document.createElement('div');
                        pill.className = 'event-pill pill-holiday';
                        pill.innerHTML = `<i class="fas fa-tree fa-fw"></i> <span>${holidayName}</span>`;
                        contentWrapper.appendChild(pill);
                    } else if (isWeekend) {
                        const secondaryShiftGroupName = AppState.secondarySchedule.shifts[dateStr];
                        if (secondaryShiftGroupName) {
                             const pill = document.createElement('div');
                             pill.className = 'event-pill pill-weekend';
                             pill.innerHTML = `<i class="fas fa-plane fa-fw"></i> <span>${secondaryShiftGroupName}</span>`;
                             contentWrapper.appendChild(pill);
                        }
                    }

                } else if (AppState.activeView === 'secondary') {
                    dayCell.classList.remove('cursor-pointer');
                    if (isWeekend && !holidayName) {
                        const secondaryShiftGroupName = AppState.secondarySchedule.shifts[dateStr];
                        if (secondaryShiftGroupName) {
                            const groupInfo = AppState.secondarySchedule.groupDefinitions.find(g => g.name === secondaryShiftGroupName);
                            if (groupInfo) {
                                const pill = document.createElement('div');
                                pill.className = 'event-pill pill-secondary';
                                pill.innerHTML = `<i class="fas fa-users-cog fa-fw"></i> <span>${groupInfo.name} 組</span>`;
                                const membersPill = document.createElement('div');
                                membersPill.className = 'event-pill';
                                membersPill.textContent = groupInfo.members.join(', ');
                                membersPill.style.backgroundColor = '#f1f5f9';
                                membersPill.style.color = '#475569';
                                membersPill.style.fontSize = '0.75rem';
                                contentWrapper.appendChild(pill);
                                contentWrapper.appendChild(membersPill);
                            }
                        }
                    }
                }
                
                dayCell.appendChild(contentWrapper);
                UIElements.calendarGrid.appendChild(dayCell);
            }
            const totalCells = dayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-day blank bg-slate-50/50 cursor-default';
                UIElements.calendarGrid.appendChild(blankCell);
            }
            UI.bindCalendarEvents();
            UI.updateBatchActionUI();
        },
        changeMonth: (offset) => {
            DataStorage.saveData();
            AppState.multiSelectedDates.clear();
            AppState.currentMonth += offset;
            if (AppState.currentMonth < 0) {
                AppState.currentMonth = 11;
                AppState.currentYear--;
            } else if (AppState.currentMonth > 11) {
                AppState.currentMonth = 0;
                AppState.currentYear++;
            }
            DataStorage.loadData();
            UI.updateAllUI();
            Calendar.render();
        }
    };

    // --- SCHEDULE PARSING ---
    const ScheduleParser = {
        parseTextToIntermediateData: (text, inputYear, inputMonth_1_indexed) => {
            const lines = text.split('\n').map(line => line.trimEnd());
            let yearToUse = inputYear;
            let monthToUse_0_indexed = inputMonth_1_indexed !== null ? inputMonth_1_indexed - 1 : null;
            let tempStaffNames = new Set();
            let tempShifts = {};
            for (const line of lines) {
                const yearMonthMatch = line.match(/(\d+)\s*年\s*(\d+)\s*月/);
                if (yearMonthMatch) {
                    let parsedYearFromText = parseInt(yearMonthMatch[1]);
                    if (parsedYearFromText < 200 && parsedYearFromText > 90) parsedYearFromText += 1911;
                    yearToUse = parsedYearFromText;
                    monthToUse_0_indexed = parseInt(yearMonthMatch[2]) - 1;
                    break;
                }
            }
            if (!yearToUse || isNaN(yearToUse)) yearToUse = AppState.currentYear;
            if (monthToUse_0_indexed === null || isNaN(monthToUse_0_indexed)) monthToUse_0_indexed = AppState.currentMonth;
            
            let dateHeaderLineIndex = -1;
            let datePositions = {};
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes("姓名") && /\d/.test(lines[i])) {
                    dateHeaderLineIndex = i;
                    const dayRegex = /\b(\d{1,2})\b/g;
                    let match;
                    while ((match = dayRegex.exec(lines[i])) !== null) {
                        datePositions[parseInt(match[1])] = match.index + Math.floor(match[1].length / 2);
                    }
                    break;
                }
            }

            if (Object.keys(datePositions).length > 0) {
                 for (let i = dateHeaderLineIndex + 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim() === "" || line.match(/^\s*\d+月/) || line.includes("平日") || line.includes("假日")) continue;
                    const nameMatch = line.match(/^([^\s值日一二三四五六0-9]+(?:\s+[^\s值日一二三四五六0-9]+)*)/);
                    if (!nameMatch || !nameMatch[0] || nameMatch[0].length >= 10 || nameMatch[0].trim() === "姓名") continue;
                    const staffName = nameMatch[0].trim();
                    tempStaffNames.add(staffName);
                    for (const dayNumStr in datePositions) {
                        const charIndexForDay = datePositions[dayNumStr];
                        if (charIndexForDay < line.length && (line[charIndexForDay].match(/[值vVoO0]/))) {
                            const dateStr = `${yearToUse}-${String(monthToUse_0_indexed + 1).padStart(2, '0')}-${String(dayNumStr).padStart(2, '0')}`;
                            tempShifts[dateStr] = staffName;
                        }
                    }
                 }
            }
            const success = tempStaffNames.size > 0 || Object.keys(tempShifts).length > 0;
            return { success, parsedYear: yearToUse, parsedMonth: monthToUse_0_indexed, parsedStaffNames: Array.from(tempStaffNames), parsedShifts: tempShifts };
        },
        applyParsedDataToAppState: (year, month_0_indexed, shiftsToApply, staffNamesToApply) => {
            AppState.currentYear = year;
            AppState.currentMonth = month_0_indexed;
            const combinedStaffNames = new Set([...AppState.staffNames, ...staffNamesToApply]);
            AppState.staffNames = Array.from(combinedStaffNames);
            StaffManager.assignColorsToStaff();
            const targetMonthPrefix = `${year}-${String(month_0_indexed + 1).padStart(2, '0')}`;
            Object.keys(AppState.shifts).forEach(key => { if(key.startsWith(targetMonthPrefix)) delete AppState.shifts[key]});
            Object.assign(AppState.shifts, shiftsToApply);
            DataStorage.saveData();
            UI.updateAllUI();
            Calendar.render();
            Utils.showCustomAlert(`主要班表已成功匯入/更新 ${year}年${month_0_indexed + 1}月 的資料！`, "success");
        },
        triggerImportScheduleFromPastedText: () => {
            if (!UIElements.fullSchedulePasteArea) return;
            const text = UIElements.fullSchedulePasteArea.value;
            if (!text.trim()) {
                Utils.showCustomAlert("請先在文字區域貼上主要的班表內容。", "info");
                return;
            }
            const intermediateData = ScheduleParser.parseTextToIntermediateData(text, AppState.currentYear, AppState.currentMonth + 1);
            if (intermediateData.success) {
                ScheduleParser.applyParsedDataToAppState(intermediateData.parsedYear, intermediateData.parsedMonth, intermediateData.parsedShifts, intermediateData.parsedStaffNames);
                 UIElements.fullSchedulePasteArea.value = "";
                 UI.closeManagementModal();
            } else {
                 Utils.showCustomAlert("未能在貼上的文字中找到任何有效的主要班表資料。", "error");
            }
        }
    };
    
    // --- UI HANDLING ---
    const UI = {
        cacheDOMElements: () => {
            const ids = [
                'mainTitle', 'monthYearDisplay', 'calendarGrid', 'staffNameInput', 'fullSchedulePasteArea', 
                'staffList', 'assignmentModal', 'modalStaffList', 'noStaffMessage', 'draggableStaffList',
                'customAlert', 'customAlertMessage', 'staffFilterSelect', 'autoScheduleConfirmModal', 
                'autoScheduleConfirmMessage', 'confirmAutoScheduleButton', 'startMonThuSelect', 
                'startFriSelect', 'startWeekendSelect', 'primaryScheduleTabButton', 'secondaryScheduleTabButton', 
                'primaryScheduleControls', 'secondaryScheduleControlsAboveCalendar', 'secondaryStaffInfoDiv', 
                'toggleSecondaryStaffInfoButton', 'exportPrimaryScheduleButton', 'exportButtonText',
                'savePrimaryScheduleButton', 'clearPrimaryScheduleButton', 'managementModal', 
                'openManagementModalButton', 'closeManagementModalButton', 'sentryStartDate', 
                'sentryStartTime', 'confirmModal', 'confirmModalMessage', 'acceptConfirmButton', 
                'cancelConfirmButton', 'batchActions', 'batchAssignButton', 'batchClearButton', 'selectionCount'
            ];
            ids.forEach(id => UIElements[id] = document.getElementById(id));
            UIElements.staffListDiv = document.getElementById('staffList'); 
            UIElements.confirmModalTitle = document.querySelector('#confirmModalTitle span');
        },
        updateAllUI: () => {
            UI.updateStaffListUI();
            UI.updateStaffFilterUI();
            UI.updateSentryScheduleFormUI();
            UI.updateBatchActionUI();
            UI.updateExportButtonUI(); // <<<--- 新增呼叫 ---<<<
        },
        // <<<--- 新增函式：更新匯出按鈕的UI ---<<<
        updateExportButtonUI: () => {
            if (!UIElements.exportButtonText || !UIElements.staffFilterSelect) return;
            const selectedStaff = UIElements.staffFilterSelect.value;
            if (selectedStaff === 'ALL') {
                UIElements.exportButtonText.textContent = '匯出主要班表 (.ics)';
            } else {
                UIElements.exportButtonText.textContent = `匯出 ${selectedStaff} 的班表 (.ics)`;
            }
        },
        setActiveView: (viewName) => {
            AppState.activeView = viewName;
            AppState.multiSelectedDates.clear();
            const isPrimary = viewName === 'primary';
            UIElements.primaryScheduleTabButton.classList.toggle('active-tab', isPrimary);
            UIElements.secondaryScheduleTabButton.classList.toggle('active-tab', !isPrimary);
            UIElements.primaryScheduleControls.style.display = isPrimary ? 'block' : 'none';
            UIElements.secondaryScheduleControlsAboveCalendar.classList.toggle('hidden', isPrimary);
            if (!isPrimary && UIElements.secondaryStaffInfoDiv) { 
                const showInfo = AppState.secondarySchedule.isStaffInfoVisible;
                UIElements.secondaryStaffInfoDiv.classList.toggle('hidden', !showInfo);
                UIElements.toggleSecondaryStaffInfoButton.innerHTML = showInfo ? '<i class="fas fa-eye-slash"></i> 隱藏組別成員' : '<i class="fas fa-eye"></i> 顯示組別成員';
            }
            Calendar.render();
        },
        toggleSecondaryStaffInfo: () => {
            AppState.secondarySchedule.isStaffInfoVisible = !AppState.secondarySchedule.isStaffInfoVisible;
            UI.setActiveView('secondary');
        },
        updateStaffListUI: () => {
            if (!UIElements.staffListDiv || !UIElements.draggableStaffList) return;
            UIElements.staffListDiv.innerHTML = '';
            UIElements.draggableStaffList.innerHTML = '';

            if (AppState.staffNames.length === 0) {
                UIElements.staffListDiv.innerHTML = '<p class="text-sm text-slate-500 p-2">尚未新增人員。</p>';
                UIElements.draggableStaffList.innerHTML = '<p class="text-sm text-slate-500 p-2">請在管理設定中新增人員。</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-1';
            
            AppState.staffNames.forEach((name, index) => {
                const personColor = AppState.staffColors[name] || PREDEFINED_COLORS[0];
                const li = document.createElement('li');
                li.className = 'text-sm p-2 bg-slate-50 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${personColor.background}; border: 1px solid ${personColor.text};"></span>
                        <span>${name}</span>
                    </div>
                    <button type="button" class="btn btn-ghost text-red-500 hover:bg-red-100 p-1 h-6 w-6" title="移除 ${name}" onclick="event.stopPropagation(); StaffManager.removeStaffMember(${index});">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                ul.appendChild(li);

                const dragItem = document.createElement('div');
                dragItem.className = 'p-2 rounded-md flex items-center gap-2 draggable-staff-item';
                dragItem.style.backgroundColor = personColor.background;
                dragItem.style.color = personColor.text;
                dragItem.draggable = true;
                dragItem.dataset.staffName = name;
                dragItem.innerHTML = `<i class="fa-solid fa-grip-vertical"></i> ${name}`;
                UIElements.draggableStaffList.appendChild(dragItem);
            });
            UIElements.staffListDiv.appendChild(ul);
            UI.bindDraggableEvents();
        },
        updateSentryScheduleFormUI: () => {
             if (!UIElements.sentryStartDate || !UIElements.sentryStartTime) return;
            const { initialCondition, timeSlots } = AppState.sentrySchedule;
            UIElements.sentryStartDate.value = initialCondition.date;
            const select = UIElements.sentryStartTime;
            select.innerHTML = '';
            timeSlots.forEach(slot => select.add(new Option(slot, slot)));
            select.value = initialCondition.time;
        },
        updateStaffFilterUI: () => {
            if (!UIElements.staffFilterSelect) return;
            const currentFilterValue = UIElements.staffFilterSelect.value;
            UIElements.staffFilterSelect.innerHTML = '';
            UIElements.staffFilterSelect.add(new Option("所有主要班表人員", "ALL"));
            AppState.staffNames.forEach(name => UIElements.staffFilterSelect.add(new Option(name, name)));
            if (AppState.staffNames.includes(currentFilterValue)) {
                UIElements.staffFilterSelect.value = currentFilterValue;
            } else {
                 UIElements.staffFilterSelect.value = "ALL";
                 AppState.selectedStaffForFilter = "ALL";
            }
        },
        openAssignmentModal: () => {
            UIElements.modalStaffList.innerHTML = '';
            const hasStaff = AppState.staffNames.length > 0;
            UIElements.noStaffMessage.classList.toggle('hidden', hasStaff);
            UIElements.modalStaffList.classList.toggle('hidden', !hasStaff);
            
            if(hasStaff) {
                AppState.staffNames.forEach(name => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    const personColor = AppState.staffColors[name] || PREDEFINED_COLORS[0];
                    button.className = 'btn w-full justify-start';
                    button.style.backgroundColor = personColor.background;
                    button.style.color = personColor.text;
                    button.textContent = name;
                    button.onclick = () => UI.assignShift(name);
                    UIElements.modalStaffList.appendChild(button);
                });
            }
            UIElements.assignmentModal.style.display = 'flex';
        },
        closeAssignmentModal: () => {
            if (UIElements.assignmentModal) UIElements.assignmentModal.style.display = 'none';
        },
        assignShift: (personName) => {
            if (AppState.multiSelectedDates.size > 0) {
                AppState.multiSelectedDates.forEach(dateStr => {
                    AppState.shifts[dateStr] = personName;
                });
                Utils.showCustomAlert(`${personName} 已被指派至 ${AppState.multiSelectedDates.size} 個日期。`, "success");
                AppState.multiSelectedDates.clear();
                Calendar.render();
                DataStorage.saveData();
                UI.closeAssignmentModal();
            }
        },
        updateBatchActionUI: () => {
            const count = AppState.multiSelectedDates.size;
            if (count > 0) {
                UIElements.selectionCount.textContent = `已選定 ${count} 個日期`;
                UIElements.batchAssignButton.disabled = false;
                UIElements.batchClearButton.disabled = false;
            } else {
                UIElements.selectionCount.textContent = '尚未選取任何日期';
                UIElements.batchAssignButton.disabled = true;
                UIElements.batchClearButton.disabled = true;
            }
        },
        bindCalendarEvents: () => {
            document.querySelectorAll('.calendar-day:not(.blank)').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    const date = cell.dataset.date;
                    if (!date || AppState.activeView !== 'primary') return;

                    if (e.ctrlKey || e.metaKey) { 
                        if (AppState.multiSelectedDates.has(date)) {
                            AppState.multiSelectedDates.delete(date);
                        } else {
                            AppState.multiSelectedDates.add(date);
                        }
                    } else {
                        if (AppState.multiSelectedDates.size === 1 && AppState.multiSelectedDates.has(date)) {
                            AppState.multiSelectedDates.clear();
                        } else {
                            AppState.multiSelectedDates.clear();
                            AppState.multiSelectedDates.add(date);
                        }
                    }
                    Calendar.render();
                });

                cell.addEventListener('dragover', e => {
                    e.preventDefault();
                    cell.classList.add('drag-over');
                });
                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('drag-over');
                });
                cell.addEventListener('drop', e => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    const staffName = e.dataTransfer.getData('text/plain');
                    const date = cell.dataset.date;
                    if(staffName && date) {
                        AppState.shifts[date] = staffName;
                        AppState.multiSelectedDates.clear();
                        Calendar.render();
                        DataStorage.saveData();
                        Utils.showCustomAlert(`${staffName} 已被指派至 ${date}`, 'success');
                    }
                });
            });
        },
        bindDraggableEvents: () => {
            document.querySelectorAll('.draggable-staff-item').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.staffName);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
        },
        openAutoScheduleConfirmModal: (defaults = {}) => {
            UIElements.autoScheduleConfirmMessage.textContent = `您確定要為 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 自動產生主要班表嗎？\n這將會覆蓋本月現有的每日主要班表排班。`;
            [UIElements.startMonThuSelect, UIElements.startFriSelect, UIElements.startWeekendSelect].forEach(select => {
                select.innerHTML = '<option value="">依預設排序 (名單首位)</option>';
                AppState.staffNames.forEach(name => select.add(new Option(name, name)));
            });
            if (defaults.monThu) UIElements.startMonThuSelect.value = defaults.monThu;
            if (defaults.fri) UIElements.startFriSelect.value = defaults.fri;
            if (defaults.weekend) UIElements.startWeekendSelect.value = defaults.weekend;
            UIElements.autoScheduleConfirmModal.style.display = 'flex';
        },
        closeAutoScheduleConfirmModal: () => { if (UIElements.autoScheduleConfirmModal) UIElements.autoScheduleConfirmModal.style.display = 'none'; },
        openManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'flex'; },
        closeManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'none'; },
        openConfirmModal: (title, message, onConfirm) => {
            UIElements.confirmModalTitle.textContent = title;
            UIElements.confirmModalMessage.textContent = message;
            UIElements.acceptConfirmButton.onclick = () => { onConfirm(); UI.closeConfirmModal(); };
            UIElements.confirmModal.style.display = 'flex';
        },
        closeConfirmModal: () => { if(UIElements.confirmModal) UIElements.confirmModal.style.display = 'none'; }
    };
    
    // --- EXPORTER (MODIFIED) ---
    const Exporter = {
        exportToICS: (staffNameToExport = 'ALL') => {
            const { currentYear, currentMonth, shifts, staffNames, holidays } = AppState;
            const monthStr = String(currentMonth + 1).padStart(2, '0');
            
            const isExportingAll = staffNameToExport === 'ALL' || !staffNames.includes(staffNameToExport);
            const scheduleName = isExportingAll 
                ? `${currentYear}年 ${currentMonth + 1}月 主要班表`
                : `${currentYear}年 ${currentMonth + 1}月 ${staffNameToExport} 班表`;

            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//SHIFT TOOL v7.2//NONSGML v1.0//EN',
                `X-WR-CALNAME:${scheduleName}`
            ].join('\r\n') + '\r\n';

            // 處理主要班表輪值
            for (const dateKey in shifts) {
                if (dateKey.startsWith(`${currentYear}-${monthStr}`)) {
                    const person = shifts[dateKey];
                    if (person && (isExportingAll || person === staffNameToExport)) {
                        const date = new Date(dateKey + 'T00:00:00');
                        const year = date.getUTCFullYear();
                        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                        const day = String(date.getUTCDate()).padStart(2, '0');
                        const startDate = `${year}${month}${day}`;
                        
                        const nextDay = new Date(date);
                        nextDay.setUTCDate(nextDay.getUTCDate() + 1);
                        const nextYear = nextDay.getUTCFullYear();
                        const nextMonth = String(nextDay.getUTCMonth() + 1).padStart(2, '0');
                        const nextDayOfMonth = String(nextDay.getUTCDate()).padStart(2, '0');
                        const endDate = `${nextYear}${nextMonth}${nextDayOfMonth}`;

                        icsContent += [
                            'BEGIN:VEVENT',
                            `UID:${dateKey}@shiftool.app`,
                            `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}`,
                            `DTSTART;VALUE=DATE:${startDate}`,
                            `DTEND;VALUE=DATE:${endDate}`,
                            `SUMMARY:輪值: ${person}`,
                            'END:VEVENT'
                        ].join('\r\n') + '\r\n';
                    }
                }
            }
            
            // 處理當月假期 (為個人班表提供上下文)
            for (const dateKey in holidays) {
                 if (dateKey.startsWith(`${currentYear}-${monthStr}`)) {
                    const holidayName = holidays[dateKey];
                    const date = new Date(dateKey + 'T00:00:00');
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    const startDate = `${year}${month}${day}`;

                    const nextDay = new Date(date);
                    nextDay.setUTCDate(nextDay.getUTCDate() + 1);
                    const nextYear = nextDay.getUTCFullYear();
                    const nextMonth = String(nextDay.getUTCMonth() + 1).padStart(2, '0');
                    const nextDayOfMonth = String(nextDay.getUTCDate()).padStart(2, '0');
                    const endDate = `${nextYear}${nextMonth}${nextDayOfMonth}`;

                    icsContent += [
                        'BEGIN:VEVENT',
                        `UID:holiday-${dateKey}@shiftool.app`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}`,
                        `DTSTART;VALUE=DATE:${startDate}`,
                        `DTEND;VALUE=DATE:${endDate}`,
                        `SUMMARY:${holidayName}`,
                        'END:VEVENT'
                    ].join('\r\n') + '\r\n';
                 }
            }

            icsContent += 'END:VCALENDAR';
            
            const filename = isExportingAll
                ? `SHIFT_TOOL_${currentYear}_${monthStr}.ics`
                : `SHIFT_TOOL_${currentYear}_${monthStr}_${staffNameToExport}.ics`;
            
            Exporter.downloadICS(icsContent, filename);
            Utils.showCustomAlert(`${scheduleName} .ics 檔案已開始下載。`, 'success');
        },

        downloadICS: (content, filename) => {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement("a");
            if(link.href) URL.revokeObjectURL(link.href);
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };
    
    // --- AUTO SCHEDULER ---
    const AutoScheduler = {
        triggerAutoSchedule: () => {
            if (AppState.staffNames.length === 0) {
                Utils.showCustomAlert("請先新增主要班表人員名單才能自動排班。", "info"); return;
            }
            const currentMonthKey = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            UI.openAutoScheduleConfirmModal(AppState.defaultPrimaryScheduleStarters[currentMonthKey] || {});
        },
        proceedWithAutoSchedule: () => {
            Utils.showCustomAlert("正在自動產生主要班表...", "loading", 0);
            const targetMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            Object.keys(AppState.shifts).forEach(key => { if (key.startsWith(targetMonthPrefix)) delete AppState.shifts[key]; });
            
            const startMonThuName = UIElements.startMonThuSelect.value;
            const startFriName = UIElements.startFriSelect.value;
            const startWeekendName = UIElements.startWeekendSelect.value;
            const newShifts = AutoScheduler.generateBasicRoundRobin(AppState.currentYear, AppState.currentMonth, AppState.staffNames, startMonThuName, startFriName, startWeekendName);
            
            Object.assign(AppState.shifts, newShifts);
            DataStorage.saveData();
            Calendar.render();
            Utils.hideCustomAlert();
            Utils.showCustomAlert(`已為 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 自動產生主要班表。`, "success");
        },
        generateBasicRoundRobin: (year, month, staffList, startMonThu, startFri, startWeekend) => {
            const newShifts = {};
            if (!staffList || staffList.length === 0) return newShifts;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const getStartIndex = (startName) => startName && staffList.includes(startName) ? staffList.indexOf(startName) : 0;
            let monThuIdx = getStartIndex(startMonThu);
            let friIdx = getStartIndex(startFri);
            let weekendIdx = getStartIndex(startWeekend);

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = new Date(year, month, day).getDay();
                if (newShifts[dateStr]) continue;

                if (dayOfWeek >= 1 && dayOfWeek <= 4) {
                    newShifts[dateStr] = staffList[monThuIdx];
                    monThuIdx = (monThuIdx + 1) % staffList.length;
                } else if (dayOfWeek === 5) {
                    newShifts[dateStr] = staffList[friIdx];
                    friIdx = (friIdx + 1) % staffList.length;
                } else if (dayOfWeek === 6) { 
                    const person = staffList[weekendIdx];
                    newShifts[dateStr] = person;
                    if (day + 1 <= daysInMonth && new Date(year, month, day + 1).getDay() === 0) {
                        const sunDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day + 1).padStart(2, '0')}`;
                        newShifts[sunDateStr] = person;
                    }
                    weekendIdx = (weekendIdx + 1) % staffList.length;
                } else if (dayOfWeek === 0 && !newShifts[dateStr]) {
                    newShifts[dateStr] = staffList[weekendIdx];
                    weekendIdx = (weekendIdx + 1) % staffList.length;
                }
            }
            return newShifts;
        },
        carryOverToNextMonth: () => {
             if (AppState.staffNames.length === 0) {
                Utils.showCustomAlert("請先新增主要班表人員。", "info"); return;
            }
            Utils.showCustomAlert("正在預排次月班表...", "loading", 0);
            const { currentYear, currentMonth, staffNames, shifts } = AppState;
            const getLastAssigned = (condition) => {
                for (let day = new Date(currentYear, currentMonth + 1, 0).getDate(); day >= 1; day--) {
                    const date = new Date(currentYear, currentMonth, day);
                    if (condition(date.getDay())) {
                        const person = shifts[Utils.formatDateToKey(date)];
                        if (person) return person;
                    }
                }
                return null;
            };
            const lastMonThu = getLastAssigned(d => d >= 1 && d <= 4);
            const lastFri = getLastAssigned(d => d === 5);
            const lastWeekend = getLastAssigned(d => d === 0 || d === 6);
            const getNextStaff = (name) => {
                if (!name || !staffNames.includes(name)) return staffNames[0] || "";
                return staffNames[(staffNames.indexOf(name) + 1) % staffNames.length];
            };
            
            Calendar.changeMonth(1); 
            
            const nextMonthKey = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            const defaults = AppState.defaultPrimaryScheduleStarters[nextMonthKey] || {};
            const finalStartMonThu = defaults.monThu || getNextStaff(lastMonThu);
            const finalStartFri = defaults.fri || getNextStaff(lastFri);
            const finalStartWeekend = defaults.weekend || getNextStaff(lastWeekend);

            const targetMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            Object.keys(AppState.shifts).forEach(key => { if (key.startsWith(targetMonthPrefix)) delete AppState.shifts[key]; });

            const newShifts = AutoScheduler.generateBasicRoundRobin(AppState.currentYear, AppState.currentMonth, AppState.staffNames, finalStartMonThu, finalStartFri, finalStartWeekend);
            Object.assign(AppState.shifts, newShifts);

            DataStorage.saveData();
            UI.setActiveView('primary');
            UI.updateAllUI();
            Calendar.render();
            Utils.hideCustomAlert();
            Utils.showCustomAlert(`已自動預排 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的主要班表。`, "success");
        }
    };

    // --- INITIALIZATION & EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        UI.cacheDOMElements();
        DataStorage.loadData();
        
        if (Object.keys(AppState.sentrySchedule.shifts).length === 0) {
            SentryScheduler.recalculateAll();
        }

        UI.updateAllUI();
        UI.setActiveView(AppState.activeView);

        // --- Event Listeners ---
        UIElements.staffFilterSelect.addEventListener('change', (e) => {
            AppState.selectedStaffForFilter = e.target.value;
            if (AppState.activeView === 'primary') Calendar.render();
            UI.updateExportButtonUI(); // 更新匯出按鈕文字
        });
        
        // <<<--- 替換舊的 inline onclick ---<<<
        UIElements.exportPrimaryScheduleButton.addEventListener('click', () => {
            const staffToExport = UIElements.staffFilterSelect.value;
            Exporter.exportToICS(staffToExport);
        });
        
        UIElements.primaryScheduleTabButton.addEventListener('click', () => UI.setActiveView('primary'));
        UIElements.secondaryScheduleTabButton.addEventListener('click', () => UI.setActiveView('secondary'));
        if (UIElements.toggleSecondaryStaffInfoButton) {
            UIElements.toggleSecondaryStaffInfoButton.addEventListener('click', UI.toggleSecondaryStaffInfo);
        }
        UIElements.openManagementModalButton.addEventListener('click', UI.openManagementModal);
        UIElements.closeManagementModalButton.addEventListener('click', UI.closeManagementModal);
        UIElements.savePrimaryScheduleButton.addEventListener('click', () => {
            DataStorage.saveData();
            Utils.showCustomAlert("所有變更已成功儲存。", "success");
            UI.closeManagementModal();
        });
        UIElements.clearPrimaryScheduleButton.addEventListener('click', () => {
            UI.openConfirmModal('確認清除?', `您確定要永久刪除 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的所有主要班表資料嗎？`, () => {
                DataStorage.clearCurrentMonthPrimarySchedule();
                UI.closeManagementModal();
            });
        });

        UIElements.batchAssignButton.addEventListener('click', () => {
            if(AppState.multiSelectedDates.size > 0) UI.openAssignmentModal();
        });
        UIElements.batchClearButton.addEventListener('click', () => {
            if(AppState.multiSelectedDates.size > 0) {
                const count = AppState.multiSelectedDates.size;
                 UI.openConfirmModal('確認清除?', `您確定要清除 ${count} 個日期的主要班表嗎？`, () => {
                    AppState.multiSelectedDates.forEach(dateStr => {
                        delete AppState.shifts[dateStr];
                    });
                    AppState.multiSelectedDates.clear();
                    Calendar.render();
                    DataStorage.saveData();
                    Utils.showCustomAlert(`已清除 ${count} 個日期的班表。`, "success");
                });
            }
        });

        UIElements.cancelConfirmButton.addEventListener('click', UI.closeConfirmModal);
        
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                UI.closeAssignmentModal();
                UI.closeAutoScheduleConfirmModal();
                UI.closeManagementModal();
                UI.closeConfirmModal();
            }
        });
        window.onclick = (e) => {
            if (e.target == UIElements.assignmentModal) UI.closeAssignmentModal();
            if (e.target == UIElements.autoScheduleConfirmModal) UI.closeAutoScheduleConfirmModal();
            if (e.target == UIElements.managementModal) UI.closeManagementModal();
            if (e.target == UIElements.confirmModal) UI.closeConfirmModal();
        }
    });
    </script>
</body>
</html>
